<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ðŸ’ª Pushup Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pushups">
    <link rel="apple-touch-icon" href="/icon-192.svg">

    <!-- Theme color -->
    <meta name="theme-color" content="#667eea">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="config.js"></script>
    <style>
        /* Mobile-First CSS - Base styles for mobile devices */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 12px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        h1 {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 0.9em;
            opacity: 0.95;
            font-weight: 300;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            margin-bottom: 12px;
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 16px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Desktop enhancements */
        @media (min-width: 769px) {
            body {
                padding: 20px;
            }

            .container {
                max-width: 600px;
            }

            header {
                margin-bottom: 40px;
            }

            h1 {
                font-size: 3em;
                margin-bottom: 10px;
            }

            .subtitle {
                font-size: 1.2em;
            }

            .card {
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 20px;
            }

            .card h2 {
                font-size: 1.8em;
                margin-bottom: 20px;
                gap: 10px;
            }
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .label-optional {
            font-weight: 400;
            font-size: 0.85em;
            color: #888;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input:invalid:not(:placeholder-shown) {
            border-color: #f5576c;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 24px;
            border: none;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            min-height: 48px;
            touch-action: manipulation;
        }

        /* Desktop enhancements for forms */
        @media (min-width: 769px) {
            .form-group {
                margin-bottom: 20px;
            }

            label {
                margin-bottom: 8px;
                font-size: 1em;
            }

            input {
                padding: 15px;
                border-radius: 12px;
            }

            .btn {
                padding: 15px 30px;
                border-radius: 30px;
                min-height: auto;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #f5f7fa;
        }

        .info-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .info-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1.2em;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-value {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .success-message {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .success-message.show {
            display: block;
        }

        .error-message {
            color: #f5576c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn-quick-add {
            padding: 20px;
            border-radius: 16px;
            border: 3px solid #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 800;
            font-size: 1.6em;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 72px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-quick-add::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .btn-quick-add:active {
            transform: scale(0.94);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .btn-quick-add:active::before {
            opacity: 1;
        }

        /* Desktop enhancements for quick-add */
        @media (min-width: 769px) {
            .quick-add-grid {
                gap: 15px;
                margin-bottom: 24px;
            }

            .btn-quick-add {
                padding: 24px;
                border-radius: 18px;
                font-size: 1.8em;
                min-height: 80px;
            }

            .btn-quick-add:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
            }

            .btn-quick-add:hover::before {
                opacity: 1;
            }

            .btn-quick-add:active {
                transform: scale(0.96);
            }
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-group input {
            flex: 1;
        }

        .btn-log {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-log:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }

        .btn-log:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .today-stat {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 20px 16px;
            border-radius: 12px;
            color: white;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
        }

        .today-stat-value {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 4px;
            line-height: 1;
        }

        .today-stat-label {
            font-size: 0.95em;
            opacity: 0.95;
            font-weight: 500;
        }

        /* Desktop enhancements for today stat */
        @media (min-width: 769px) {
            .today-stat {
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 20px;
            }

            .today-stat-value {
                font-size: 2.5em;
                margin-bottom: 5px;
            }

            .today-stat-label {
                font-size: 1em;
                opacity: 0.9;
            }
        }

        /* Hero section - combines today's total with quick progress overview */
        .hero-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .hero-today {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 24px 20px;
            border-radius: 16px;
            color: white;
            text-align: center;
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }

        .hero-today-value {
            font-size: 3.5em;
            font-weight: 900;
            margin-bottom: 6px;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .hero-today-label {
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .hero-progress {
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .hero-progress-bar {
            background: #e9ecef;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .hero-progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            min-width: 3%;
        }

        .hero-progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }

        .hero-progress-label {
            color: #6c757d;
            font-weight: 500;
        }

        .hero-progress-value {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Desktop enhancements for hero */
        @media (min-width: 769px) {
            .hero-section {
                grid-template-columns: 2fr 3fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            .hero-today {
                padding: 28px 24px;
            }

            .hero-today-value {
                font-size: 4em;
            }

            .hero-progress {
                padding: 20px;
            }

            .hero-progress-bar {
                height: 14px;
                margin-bottom: 14px;
            }

            .hero-progress-stats {
                font-size: 0.9em;
            }
        }

        /* Collapsible section styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .collapsible-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-size: 1.2em;
        }

        .collapsible-toggle {
            font-size: 1.3em;
            color: #667eea;
            transition: transform 0.3s ease;
            font-weight: 600;
        }

        .collapsible-toggle.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .card.secondary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .card.secondary h2 {
            color: #6c757d;
            font-size: 1.1em;
        }

        @media (min-width: 769px) {
            .collapsible-header h2 {
                font-size: 1.4em;
            }

            .card.secondary {
                background: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }
        }

        .history-list {
            margin-top: 20px;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-amount {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .history-item-date {
            font-size: 0.9em;
            color: #6c757d;
        }

        .history-item-time {
            font-size: 0.85em;
            color: #adb5bd;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-edit:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-delete {
            background: #f5576c;
            color: white;
        }

        .btn-delete:hover {
            background: #e04455;
            transform: scale(1.05);
        }

        .btn-save {
            background: #11998e;
            color: white;
        }

        .btn-save:hover {
            background: #0d7a72;
            transform: scale(1.05);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: scale(1.05);
        }

        .edit-input {
            width: 100px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
        }

        .edit-input:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .history-item-edit-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .edit-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .edit-form-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #667eea;
        }

        .edit-form-group .edit-input {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1em;
        }

        .progress-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            margin-bottom: 20px;
        }

        .progress-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .progress-bar-text {
            font-weight: 700;
            font-size: 0.9em;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .progress-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .progress-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-stat-value {
            font-size: 1.6em;
            font-weight: 800;
            margin-bottom: 4px;
            display: block;
            line-height: 1;
        }

        .progress-stat-label {
            font-size: 0.8em;
            opacity: 0.95;
        }

        /* Desktop enhancements for progress stats */
        @media (min-width: 769px) {
            .progress-stats-grid {
                gap: 15px;
                margin-bottom: 20px;
            }

            .progress-stat {
                padding: 20px;
                border-radius: 12px;
            }

            .progress-stat-value {
                font-size: 2em;
                margin-bottom: 5px;
            }

            .progress-stat-label {
                font-size: 0.9em;
                opacity: 0.9;
            }
        }

        .projection-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .projection-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .projection-value {
            font-size: 1.4em;
            font-weight: 700;
        }

        .projection-note {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 8px;
            font-style: italic;
        }

        .stats-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .stats-tabs::-webkit-scrollbar {
            display: none;
        }

        .stats-tab {
            padding: 14px 16px;
            border: none;
            background: none;
            color: #6c757d;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .stats-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Desktop enhancements for tabs */
        @media (min-width: 769px) {
            .stats-tabs {
                gap: 10px;
                margin-bottom: 20px;
            }

            .stats-tab {
                padding: 12px 20px;
                font-size: 1em;
                min-height: auto;
            }

            .stats-tab:hover {
                color: #667eea;
            }
        }

        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stats-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stats-box-value {
            font-size: 2em;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stats-box-label {
            font-size: 0.9em;
            color: #2c3e50;
            font-weight: 600;
        }

        .stats-box-sublabel {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 3px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chart-canvas {
            width: 100%;
            height: 250px;
            display: block;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .day-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .day-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .day-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .day-item-date {
            font-weight: 600;
            color: #2c3e50;
        }

        .day-item-total {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .day-item.best {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .day-item.best .day-item-date,
        .day-item.best .day-item-total {
            color: white;
        }

        .day-item.worst {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }

        .day-item.worst .day-item-date,
        .day-item.worst .day-item-total {
            color: white;
        }

        .period-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .period-item-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .period-item-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .empty-stats {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-stats-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .badges-container {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 8px;
        }

        .badges-container::-webkit-scrollbar {
            display: none;
        }

        .badge-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0.4;
            position: relative;
            min-width: 100px;
            flex-shrink: 0;
        }

        .badge-item.earned {
            opacity: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .badge-icon {
            font-size: 2.2em;
            margin-bottom: 6px;
            display: block;
        }

        .badge-name {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .badge-description {
            font-size: 0.7em;
            opacity: 0.8;
        }

        /* Desktop enhancements for badges */
        @media (min-width: 769px) {
            .badges-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
                margin-top: 20px;
                overflow-x: visible;
                padding-bottom: 0;
            }

            .badge-item {
                padding: 15px;
                border-radius: 12px;
                min-width: auto;
            }

            .badge-item.earned {
                transform: scale(1.05);
            }

            .badge-item.earned:hover {
                transform: scale(1.1);
            }

            .badge-icon {
                font-size: 2.5em;
                margin-bottom: 8px;
            }

            .badge-name {
                font-size: 0.9em;
                margin-bottom: 3px;
            }

            .badge-description {
                font-size: 0.75em;
            }
        }

        .badge-locked {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1em;
        }

        .streak-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 16px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 6px 16px rgba(245, 87, 108, 0.3);
            text-align: center;
        }

        .streak-value {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 4px;
            line-height: 1;
        }

        .streak-label {
            font-size: 0.85em;
            opacity: 0.95;
            font-weight: 400;
        }

        .streak-icon {
            font-size: 1.5em;
            margin-right: 6px;
        }

        /* Desktop enhancements for streak display */
        @media (min-width: 769px) {
            .streak-display {
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);
            }

            .streak-value {
                font-size: 3em;
                margin-bottom: 5px;
            }

            .streak-label {
                font-size: 1em;
                opacity: 0.9;
                font-weight: 300;
            }

            .streak-icon {
                font-size: 2em;
                margin-right: 10px;
            }
        }

        .status-indicator {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-indicator.ahead {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .status-indicator.on-track {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .status-indicator.behind {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }

        .status-indicator.no-deadline {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
        }

        .status-icon {
            font-size: 1.5em;
        }

        .gamification-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        /* Desktop enhancements for gamification grid */
        @media (min-width: 769px) {
            .gamification-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }
        }

        .sync-status {
            background: #f8f9fa;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            flex-wrap: wrap;
        }

        /* Desktop enhancements for sync status */
        @media (min-width: 769px) {
            .sync-status {
                padding: 15px 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                gap: 15px;
                flex-wrap: nowrap;
            }
        }

        .sync-status.syncing {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .sync-status.synced {
            border-color: #11998e;
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%);
        }

        .sync-status.error {
            border-color: #f5576c;
            background: linear-gradient(135deg, rgba(245, 87, 108, 0.1) 0%, rgba(240, 68, 85, 0.1) 100%);
        }

        .sync-status.offline {
            border-color: #ff8e53;
            background: linear-gradient(135deg, rgba(255, 142, 83, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
        }

        .sync-status-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .sync-status-icon {
            font-size: 1.5em;
        }

        .sync-status-text {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .sync-status-main {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .sync-status-sub {
            font-size: 0.8em;
            color: #6c757d;
        }

        #offline-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff8e53 0%, #ff6b6b 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            font-weight: 600;
            font-size: 0.9em;
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        #offline-indicator .indicator-icon {
            font-size: 1.2em;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .sync-status-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sync {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-sync:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-sync:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-google-signin {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #4285f4;
            background: white;
            color: #4285f4;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-google-signin:hover {
            background: #f1f3f4;
            transform: translateY(-1px);
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        .sync-settings-card {
            background: #f8f9fa;
            padding: 14px;
            border-radius: 10px;
            margin-top: 12px;
        }

        .sync-settings-title {
            font-size: 1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .sync-settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Desktop enhancements for sync settings */
        @media (min-width: 769px) {
            .sync-settings-card {
                padding: 20px;
                border-radius: 12px;
                margin-top: 20px;
            }

            .sync-settings-title {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .sync-settings-option {
                padding: 12px 0;
            }
        }

        .sync-settings-option:last-child {
            border-bottom: none;
        }

        .sync-settings-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .sync-settings-value {
            color: #6c757d;
            font-size: 0.9em;
        }

        /* User Account View Styles */
        .user-account-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            margin-bottom: 12px;
        }

        @media (min-width: 769px) {
            .user-account-card {
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 20px;
            }
        }

        .user-account-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .user-account-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            color: white;
            flex-shrink: 0;
        }

        .user-account-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-account-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-account-name {
            font-size: 1em;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1.2;
        }

        .user-account-email {
            font-size: 0.85em;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }

        .sync-mode-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.95em;
        }

        .sync-mode-indicator.google-sync {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%);
            border: 2px solid #11998e;
        }

        .sync-mode-indicator.local-only {
            background: linear-gradient(135deg, rgba(255, 142, 83, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
            border: 2px solid #ff8e53;
        }

        .sync-mode-icon {
            font-size: 1.3em;
        }

        .sync-mode-text {
            flex: 1;
        }

        .sync-mode-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .sync-mode-subtitle {
            font-size: 0.85em;
            color: #6c757d;
        }

        .user-account-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 769px) {
            .user-account-actions {
                flex-direction: row;
            }
        }

        .btn-account-action {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-account-action:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .btn-account-action.danger {
            border-color: #f5576c;
            color: #f5576c;
        }

        .btn-account-action.danger:hover {
            background: #f5576c;
            color: white;
        }

        .btn-account-action.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .btn-account-action.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .local-mode-message {
            background: linear-gradient(135deg, rgba(255, 142, 83, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
            border: 2px solid #ff8e53;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .local-mode-message-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .local-mode-message-text {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .btn-disconnect {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #f5576c;
            background: white;
            color: #f5576c;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-disconnect:hover {
            background: #f5576c;
            color: white;
        }

        /* History items - mobile optimized */
        .history-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .history-item-actions {
            width: 100%;
            justify-content: flex-end;
        }

        /* Stats grid - mobile optimized */
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .chart-canvas {
            height: 180px;
        }

        /* Desktop enhancements for history and stats */
        @media (min-width: 769px) {
            .history-item {
                flex-direction: row;
                align-items: center;
                gap: 0;
            }

            .history-item-actions {
                width: auto;
            }

            .chart-canvas {
                height: 250px;
            }
        }

        /* ===== AUTH LOCK SCREEN ===== */
        /* Full-screen blocking authentication gate */

        .auth-lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px 24px 32px 24px;
            overflow: hidden;
        }

        .auth-lock-screen.hidden {
            display: none;
        }

        /* App Identity Section */
        .auth-app-identity {
            text-align: center;
            margin-top: 20px;
        }

        .auth-app-icon {
            font-size: 64px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }

        .auth-app-title {
            font-size: 2em;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .auth-app-subtitle {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        /* User Identity Area */
        .auth-user-identity {
            text-align: center;
            margin-top: 40px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
        }

        .auth-user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            object-fit: cover;
        }

        .auth-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .auth-user-name {
            font-size: 1.3em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .auth-user-status {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        /* Primary Actions Container */
        .auth-actions {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: auto;
            margin-bottom: 20px;
        }

        /* Google Sign-In Button */
        .auth-btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            color: #3c4043;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 8px 24px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 52px;
        }

        .auth-btn-google:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 12px 32px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .auth-btn-google:active {
            transform: translateY(0);
        }

        .auth-btn-google svg {
            width: 20px;
            height: 20px;
        }

        /* Skip Button */
        .auth-btn-skip {
            background: transparent;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
        }

        .auth-btn-skip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }

        .auth-skip-disclaimer {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
            text-align: center;
        }

        /* Continue CTA */
        .auth-btn-continue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .auth-btn-continue:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.5;
        }

        .auth-btn-continue:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .auth-btn-continue:not(:disabled):active {
            transform: translateY(0);
        }

        /* Desktop Enhancements */
        @media (min-width: 769px) {
            .auth-lock-screen {
                padding: 60px 40px 48px 40px;
            }

            .auth-app-identity {
                margin-top: 40px;
            }

            .auth-app-icon {
                font-size: 80px;
                margin-bottom: 20px;
            }

            .auth-app-title {
                font-size: 2.5em;
            }

            .auth-app-subtitle {
                font-size: 1.1em;
            }

            .auth-user-identity {
                margin-top: 60px;
            }

            .auth-actions {
                max-width: 380px;
                margin-bottom: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Lock Screen - First-Launch Authentication Gate -->
    <div id="authLockScreen" class="auth-lock-screen">
        <!-- App Identity -->
        <div class="auth-app-identity">
            <div class="auth-app-icon">ðŸ’ª</div>
            <div class="auth-app-title">Pushup Tracker</div>
            <div class="auth-app-subtitle">Track. Commit. Finish.</div>
        </div>

        <!-- User Identity Area (Conditional) -->
        <div id="authUserIdentity" class="auth-user-identity">
            <!-- Before Login -->
            <div id="authIdentityBefore">
                <div class="auth-user-avatar">ðŸ‘¤</div>
                <div class="auth-user-status">Not signed in</div>
            </div>

            <!-- After Login (hidden by default) -->
            <div id="authIdentityAfter" style="display: none;">
                <div class="auth-user-avatar" id="authUserAvatar">
                    <img id="authUserPicture" src="" alt="Profile" style="display: none;" />
                    <span id="authUserInitial"></span>
                </div>
                <div class="auth-user-name" id="authUserName"></div>
                <div class="auth-user-status">Signed in with Google</div>
            </div>
        </div>

        <!-- Primary Actions -->
        <div class="auth-actions">
            <!-- Google Sign-In Button (only visible when not logged in) -->
            <button id="authBtnGoogle" class="auth-btn-google">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <!-- Skip Button -->
            <div>
                <button id="authBtnSkip" class="auth-btn-skip">
                    Skip for now (Local mode)
                </button>
                <div class="auth-skip-disclaimer">Data will stay on this device</div>
            </div>

            <!-- Continue CTA (Locked until decision) -->
            <button id="authBtnContinue" class="auth-btn-continue" disabled>
                Continue â†’
            </button>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator">
        <span class="indicator-icon">ðŸ“¡</span>
        <span>Working Offline - Changes will sync when online</span>
    </div>

    <div class="container">
        <header>
            <h1>ðŸ’ª Pushup Tracker</h1>
            <p class="subtitle">Track your progress, achieve your goals</p>
        </header>

        <!-- Success Message -->
        <div id="successMessage" class="success-message">
            âœ… Settings saved successfully!
        </div>

        <!-- User Account View -->
        <div id="userAccountContainer" class="hidden">
            <!-- Logged In View -->
            <div id="loggedInView" class="user-account-card" style="display: none;">
                <div class="user-account-header">
                    <div class="user-account-avatar" id="userAvatar">
                        ðŸ‘¤
                    </div>
                    <div class="user-account-info">
                        <div class="user-account-name" id="userName">User Name</div>
                        <div class="user-account-email" id="userEmail">user@example.com</div>
                    </div>
                </div>

                <div class="sync-mode-indicator google-sync">
                    <div class="sync-mode-icon">âœ…</div>
                    <div class="sync-mode-text">
                        <div class="sync-mode-title">Google Sync Active</div>
                        <div class="sync-mode-subtitle" id="syncModeSubtitle">Your data is backed up to Google Sheets</div>
                    </div>
                </div>

                <div class="user-account-actions">
                    <button class="btn-account-action" id="viewSheetBtn">
                        <span>ðŸ“Š View Spreadsheet</span>
                    </button>
                    <button class="btn-account-action" id="manualSyncBtnNew">
                        <span>ðŸ”„ Sync Now</span>
                    </button>
                    <button class="btn-account-action danger" id="signOutBtn">
                        <span>ðŸšª Sign Out</span>
                    </button>
                </div>

                <!-- Sync Details (collapsible) -->
                <div id="syncDetails" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #f0f0f0; display: none;">
                    <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 8px;">
                        <strong>Last synced:</strong> <span id="lastSyncedNew">Never</span>
                    </div>
                    <div style="font-size: 0.9em; color: #6c757d;">
                        <strong>Pending changes:</strong> <span id="pendingChangesNew">0</span>
                    </div>
                </div>
            </div>

            <!-- Local Only View -->
            <div id="localOnlyView" class="user-account-card" style="display: none;">
                <div class="local-mode-message">
                    <div class="local-mode-message-title">
                        <span>ðŸ“±</span>
                        <span>Local-Only Mode</span>
                    </div>
                    <div class="local-mode-message-text">
                        Your pushup data is currently saved only on this device. Sign in with Google to back up your data and sync across devices.
                    </div>
                    <button class="btn-account-action primary" id="googleSignInBtnNew">
                        <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        <span style="vertical-align: middle;">Sign in with Google</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Form -->
        <div id="settingsCard" class="card">
            <h2><span>âš™ï¸</span> Goal Settings</h2>

            <form id="settingsForm">
                <div class="form-group">
                    <label for="targetInput">
                        Push-up Target
                    </label>
                    <input
                        type="number"
                        id="targetInput"
                        placeholder="e.g., 1000"
                        min="1"
                        step="1"
                        required
                    >
                    <div id="targetError" class="error-message">Please enter a positive whole number</div>
                </div>

                <div class="form-group">
                    <label for="endDateInput">
                        End Date <span class="label-optional">(optional)</span>
                    </label>
                    <input
                        type="date"
                        id="endDateInput"
                    >
                    <div id="dateError" class="error-message">End date must be in the future</div>
                </div>

                <button type="submit" class="btn btn-primary" id="saveBtn">
                    Save Goal
                </button>
            </form>
        </div>

        <!-- Log Push-ups Card - PRIORITY LAYOUT (Hidden initially if no settings) -->
        <div id="logCard" class="card hidden">
            <h2><span>ðŸ’ª</span> Log Push-ups</h2>

            <!-- Hero Section: Today's Total + Progress Overview -->
            <div class="hero-section">
                <div class="hero-today">
                    <div class="hero-today-value" id="todayTotal">0</div>
                    <div class="hero-today-label">Today's Total</div>
                </div>
                <div class="hero-progress">
                    <div class="hero-progress-bar">
                        <div class="hero-progress-fill" id="heroProgressFill" style="width: 0%;"></div>
                    </div>
                    <div class="hero-progress-stats">
                        <div>
                            <span class="hero-progress-label">Progress:</span>
                            <span class="hero-progress-value" id="heroProgressPercent">0%</span>
                        </div>
                        <div style="text-align: right;">
                            <span class="hero-progress-value" id="heroProgressCompleted">0</span>
                            <span class="hero-progress-label"> / </span>
                            <span class="hero-progress-label" id="heroProgressTarget">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Add Buttons - PRIMARY ACTION -->
            <div class="form-group">
                <div class="quick-add-grid">
                    <button class="btn-quick-add" data-value="5">5</button>
                    <button class="btn-quick-add" data-value="10">10</button>
                    <button class="btn-quick-add" data-value="25">25</button>
                    <button class="btn-quick-add" data-value="50">50</button>
                </div>
            </div>

            <!-- Custom Amount -->
            <div class="form-group">
                <label for="customAmount">Custom Amount</label>
                <div class="input-group">
                    <input
                        type="number"
                        id="customAmount"
                        placeholder="Enter number"
                        min="1"
                        step="1"
                    >
                    <button class="btn-log" id="logCustomBtn">Log</button>
                </div>
                <div id="logError" class="error-message">Please enter a positive whole number</div>
            </div>
        </div>

        <!-- At a Glance Card - COMBINED dashboard + progress + gamification (Hidden initially if no settings) -->
        <div id="dashboardCard" class="card secondary hidden">
            <div class="collapsible-header" onclick="toggleCollapsible('dashboardContent')">
                <h2><span>ðŸ“Š</span> At a Glance</h2>
                <span class="collapsible-toggle">â–¼</span>
            </div>

            <div id="dashboardContent" class="collapsible-content">
                <!-- Goal Info Compact -->
            <div class="info-box" id="goalInfo" style="margin-bottom: 16px;">
                <div class="info-item">
                    <span class="info-label">Target</span>
                    <span class="info-value" id="targetDisplay">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">End Date</span>
                    <span class="info-value" id="endDateDisplay">Not set</span>
                </div>
                <div class="info-item" id="daysRemainingRow" style="display: none;">
                    <span class="info-label">Days Left</span>
                    <span class="info-value" id="daysRemainingDisplay">-</span>
                </div>
                <div class="info-item" id="dailyPaceRow" style="display: none;">
                    <span class="info-label">Daily Pace</span>
                    <span class="info-value" id="dailyPaceDisplay">-</span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-card" style="padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                        <span class="progress-bar-text" id="progressBarText">0%</span>
                    </div>
                </div>

                <!-- Progress Stats Grid -->
                <div class="progress-stats-grid">
                    <div class="progress-stat">
                        <span class="progress-stat-value" id="totalCompleted">0</span>
                        <span class="progress-stat-label">Completed</span>
                    </div>
                    <div class="progress-stat">
                        <span class="progress-stat-value" id="totalRemaining">0</span>
                        <span class="progress-stat-label">Remaining</span>
                    </div>
                </div>
            </div>

            <!-- Streaks Side by Side -->
            <div class="gamification-grid" style="margin-bottom: 16px;">
                <div class="streak-display">
                    <div class="streak-value">
                        <span class="streak-icon">ðŸ”¥</span>
                        <span id="currentStreakValue">0</span>
                    </div>
                    <div class="streak-label">Current</div>
                </div>
                <div class="streak-display" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="streak-value">
                        <span class="streak-icon">ðŸ†</span>
                        <span id="longestStreakValue">0</span>
                    </div>
                    <div class="streak-label">Longest</div>
                </div>
            </div>

            <!-- Status Indicator -->
            <div id="statusIndicator" class="status-indicator no-deadline" style="margin-bottom: 16px;">
                <span class="status-icon">â„¹ï¸</span>
                <span id="statusText">Set an end date to track your progress status</span>
            </div>

            <!-- Badges Scrollable Row -->
            <h3 style="margin-bottom: 8px; color: #2c3e50; font-size: 0.95em;">Badges</h3>
            <div id="badgesContainer" class="badges-container">
                <!-- Badges will be rendered here -->
            </div>
            </div>
        </div>

        <!-- Hidden cards for backwards compatibility - keep IDs for JS -->
        <div id="gamificationCard" class="hidden"></div>
        <div id="progressCard" class="hidden"></div>
        <div id="projectionBox" class="hidden">
            <div class="projection-label"></div>
            <div class="projection-value" id="projectionDate"></div>
            <div class="projection-note" id="projectionNote"></div>
        </div>

        <!-- Statistics Card (Hidden initially if no settings) -->
        <div id="statisticsCard" class="card secondary hidden">
            <div class="collapsible-header" onclick="toggleCollapsible('statisticsContent')">
                <h2><span>ðŸ“ˆ</span> Statistics & Analytics</h2>
                <span class="collapsible-toggle">â–¼</span>
            </div>

            <div id="statisticsContent" class="collapsible-content">
            <!-- Tabs -->
            <div class="stats-tabs">
                <button class="stats-tab active" data-tab="overview">Overview</button>
                <button class="stats-tab" data-tab="trends">Trends</button>
                <button class="stats-tab" data-tab="periods">Periods</button>
                <button class="stats-tab" data-tab="performance">Performance</button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="stats-tab-content active">
                <div class="stats-grid">
                    <div class="stats-box">
                        <div class="stats-box-value" id="overviewDailyAvg">0</div>
                        <div class="stats-box-label">Daily Average</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-box-value" id="overviewStreak">0</div>
                        <div class="stats-box-label">Current Streak</div>
                        <div class="stats-box-sublabel">days</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-box-value" id="overviewTotalDays">0</div>
                        <div class="stats-box-label">Days Logged</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-box-value" id="overviewTotal">0</div>
                        <div class="stats-box-label">Total Push-ups</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Last 30 Days</div>
                    <canvas id="overviewChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trendsTab" class="stats-tab-content">
                <div class="stats-grid">
                    <div class="stats-box">
                        <div class="stats-box-value" id="trends7Day">0</div>
                        <div class="stats-box-label">7-Day Average</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-box-value" id="trends14Day">0</div>
                        <div class="stats-box-label">14-Day Average</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-box-value" id="trends30Day">0</div>
                        <div class="stats-box-label">30-Day Average</div>
                    </div>
                </div>

                <div class="period-selector">
                    <button class="period-btn active" data-period="7">7 Days</button>
                    <button class="period-btn" data-period="14">14 Days</button>
                    <button class="period-btn" data-period="30">30 Days</button>
                    <button class="period-btn" data-period="90">90 Days</button>
                </div>

                <div class="chart-container">
                    <div class="chart-title" id="trendsChartTitle">Daily Push-ups (Last 7 Days)</div>
                    <canvas id="trendsChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- Periods Tab -->
            <div id="periodsTab" class="stats-tab-content">
                <div class="chart-title">Weekly Totals</div>
                <div id="weeklyList"></div>

                <div class="chart-title" style="margin-top: 30px;">Monthly Totals</div>
                <div id="monthlyList"></div>
            </div>

            <!-- Performance Tab -->
            <div id="performanceTab" class="stats-tab-content">
                <div class="chart-title">Best Days</div>
                <div id="bestDaysList" class="day-list"></div>

                <div class="chart-title" style="margin-top: 30px;">Days to Improve</div>
                <div id="worstDaysList" class="day-list"></div>
            </div>
            </div>
        </div>

        <!-- Log History Card (Hidden initially if no settings) -->
        <div id="historyCard" class="card secondary hidden">
            <div class="collapsible-header" onclick="toggleCollapsible('historyContent')">
                <h2><span>ðŸ“œ</span> Log History</h2>
                <span class="collapsible-toggle">â–¼</span>
            </div>

            <div id="historyContent" class="collapsible-content">
                <div id="historyList" class="history-list">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Settings Card at Bottom (Hidden initially if no settings) -->
        <div id="settingsEditCard" class="card hidden">
            <h2><span>âš™ï¸</span> Settings</h2>
            <button class="btn btn-secondary" id="editSettingsBtn">
                Edit Goal Settings
            </button>
        </div>
    </div>

    <script>
        // Google Sheets Configuration is loaded from config.js
        // See config.example.js for setup instructions

        // Collapsible Section Toggle Function
        function toggleCollapsible(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;
            const toggle = header.querySelector('.collapsible-toggle');

            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        // Update Hero Progress Bar
        function updateHeroProgress() {
            const settings = SettingsManager.load();
            if (!settings.target) return;

            const totalCompleted = LogManager.getTotalCompleted();
            const target = settings.target;
            const progressPercent = Math.min(Math.round((totalCompleted / target) * 100), 100);

            const heroProgressFill = document.getElementById('heroProgressFill');
            const heroProgressPercent = document.getElementById('heroProgressPercent');
            const heroProgressCompleted = document.getElementById('heroProgressCompleted');
            const heroProgressTarget = document.getElementById('heroProgressTarget');

            if (heroProgressFill) heroProgressFill.style.width = progressPercent + '%';
            if (heroProgressPercent) heroProgressPercent.textContent = progressPercent + '%';
            if (heroProgressCompleted) heroProgressCompleted.textContent = totalCompleted.toLocaleString();
            if (heroProgressTarget) heroProgressTarget.textContent = target.toLocaleString();
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Offline Detection Manager
        const OfflineManager = {
            isOnline: navigator.onLine,
            statusIndicator: null,
            syncRetryInterval: null,

            init() {
                // Listen for online/offline events
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());

                // Initialize status
                this.updateOnlineStatus();

                // Start periodic sync check (every 2 minutes)
                this.syncRetryInterval = setInterval(() => {
                    if (this.isOnline && typeof GoogleSheetsSync !== 'undefined' && GoogleSheetsSync.isSignedIn) {
                        const queue = GoogleSheetsSync.getQueue();
                        if (queue.length > 0) {
                            console.log('Periodic sync check: attempting to sync pending changes');
                            GoogleSheetsSync.processPendingQueue();
                        }
                    }
                }, 120000); // 2 minutes
            },

            handleOnline() {
                this.isOnline = true;
                this.updateOnlineStatus();
                console.log('Connection restored');

                // Attempt to sync pending changes
                if (typeof GoogleSheetsSync !== 'undefined' && GoogleSheetsSync.isSignedIn) {
                    showSuccessMessage('ðŸŒ Back online - syncing pending changes...');
                    GoogleSheetsSync.processPendingQueue();
                }
            },

            handleOffline() {
                this.isOnline = false;
                this.updateOnlineStatus();
                console.log('Connection lost - working offline');
            },

            updateOnlineStatus() {
                // Update any UI indicators
                const indicator = document.getElementById('offline-indicator');
                if (indicator) {
                    if (this.isOnline) {
                        indicator.style.display = 'none';
                    } else {
                        indicator.style.display = 'flex';
                    }
                }
            },

            showOfflineToast() {
                showSuccessMessage('âš ï¸ Working offline - changes will sync when online');
            }
        };

        // Settings manager
        const Settings = {
            STORAGE_KEY: 'pushupTrackerSettings',

            load() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : null;
            },

            save(target, endDate) {
                const settings = {
                    target: parseInt(target),
                    endDate: endDate || null,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
                return settings;
            }
        };

        // Log manager
        const LogManager = {
            STORAGE_KEY: 'pushupTrackerLogs',

            load() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            },

            save(logs) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(logs));
            },

            addLog(amount) {
                const logs = this.load();
                const newLog = {
                    amount: parseInt(amount),
                    timestamp: new Date().toISOString(),
                    id: Date.now()
                };
                logs.push(newLog);
                this.save(logs);

                // Sync to Google Sheets
                if (typeof GoogleSheetsSync !== 'undefined') {
                    GoogleSheetsSync.syncAdd(newLog);
                }

                return newLog;
            },

            getAllLogs() {
                const logs = this.load();
                // Sort by timestamp, most recent first
                return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            },

            editLog(id, newAmount, newTimestamp = null) {
                const logs = this.load();
                const logIndex = logs.findIndex(log => log.id === id);
                if (logIndex !== -1) {
                    const oldTimestamp = logs[logIndex].timestamp;

                    logs[logIndex].amount = parseInt(newAmount);
                    logs[logIndex].edited = true;
                    logs[logIndex].editedAt = new Date().toISOString();

                    // Update timestamp if provided
                    if (newTimestamp) {
                        logs[logIndex].timestamp = newTimestamp;
                    }

                    this.save(logs);

                    // Sync to Google Sheets
                    if (typeof GoogleSheetsSync !== 'undefined') {
                        const timestampChanged = newTimestamp && newTimestamp !== oldTimestamp;
                        GoogleSheetsSync.syncEdit(id, parseInt(newAmount), timestampChanged ? newTimestamp : null);
                    }

                    return true;
                }
                return false;
            },

            deleteLog(id) {
                const logs = this.load();
                const filteredLogs = logs.filter(log => log.id !== id);
                if (filteredLogs.length < logs.length) {
                    this.save(filteredLogs);

                    // Sync to Google Sheets
                    if (typeof GoogleSheetsSync !== 'undefined') {
                        GoogleSheetsSync.syncDelete(id);
                    }

                    return true;
                }
                return false;
            },

            getTodayTotal() {
                const logs = this.load();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todayLogs = logs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    logDate.setHours(0, 0, 0, 0);
                    return logDate.getTime() === today.getTime();
                });

                return todayLogs.reduce((sum, log) => sum + log.amount, 0);
            },

            getTotalCompleted() {
                const logs = this.load();
                return logs.reduce((sum, log) => sum + log.amount, 0);
            },

            getAverageDailyPushups() {
                const logs = this.load();
                if (logs.length === 0) return 0;

                // Find the earliest log date
                const dates = logs.map(log => {
                    const date = new Date(log.timestamp);
                    date.setHours(0, 0, 0, 0);
                    return date.getTime();
                });
                const earliestDate = new Date(Math.min(...dates));
                earliestDate.setHours(0, 0, 0, 0);

                // Calculate days since first log
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysSinceStart = Math.ceil((today - earliestDate) / (1000 * 60 * 60 * 24)) + 1;

                // Calculate average
                const total = this.getTotalCompleted();
                return total / daysSinceStart;
            },

            // Get daily totals grouped by date
            getDailyTotals() {
                const logs = this.load();
                const dailyTotals = {};

                logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    date.setHours(0, 0, 0, 0);
                    const dateKey = date.toISOString().split('T')[0];

                    if (!dailyTotals[dateKey]) {
                        dailyTotals[dateKey] = 0;
                    }
                    dailyTotals[dateKey] += log.amount;
                });

                return dailyTotals;
            },

            // Get weekly totals
            getWeeklyTotals() {
                const logs = this.load();
                const weeklyTotals = {};

                logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay()); // Start of week (Sunday)
                    weekStart.setHours(0, 0, 0, 0);
                    const weekKey = weekStart.toISOString().split('T')[0];

                    if (!weeklyTotals[weekKey]) {
                        weeklyTotals[weekKey] = 0;
                    }
                    weeklyTotals[weekKey] += log.amount;
                });

                return weeklyTotals;
            },

            // Get monthly totals
            getMonthlyTotals() {
                const logs = this.load();
                const monthlyTotals = {};

                logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyTotals[monthKey]) {
                        monthlyTotals[monthKey] = 0;
                    }
                    monthlyTotals[monthKey] += log.amount;
                });

                return monthlyTotals;
            },

            // Get rolling average (7-day, 14-day, 30-day)
            getRollingAverage(days) {
                const dailyTotals = this.getDailyTotals();
                const dates = Object.keys(dailyTotals).sort();

                if (dates.length === 0) return 0;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const cutoffDate = new Date(today);
                cutoffDate.setDate(cutoffDate.getDate() - days + 1);

                let total = 0;
                let daysCount = 0;

                dates.forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date >= cutoffDate && date <= today) {
                        total += dailyTotals[dateKey];
                        daysCount++;
                    }
                });

                return daysCount > 0 ? total / days : 0;
            },

            // Get best days
            getBestDays(limit = 5) {
                const dailyTotals = this.getDailyTotals();
                const sortedDays = Object.entries(dailyTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, limit);

                return sortedDays.map(([date, total]) => ({
                    date: date,
                    total: total
                }));
            },

            // Get worst days (days with pushups, but lowest counts)
            getWorstDays(limit = 5) {
                const dailyTotals = this.getDailyTotals();
                const sortedDays = Object.entries(dailyTotals)
                    .sort((a, b) => a[1] - b[1])
                    .slice(0, limit);

                return sortedDays.map(([date, total]) => ({
                    date: date,
                    total: total
                }));
            },

            // Get current streak
            getCurrentStreak() {
                const dailyTotals = this.getDailyTotals();
                const dates = Object.keys(dailyTotals).sort().reverse();

                if (dates.length === 0) return 0;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayKey = today.toISOString().split('T')[0];

                // Check if we logged today or yesterday
                if (dates[0] !== todayKey) {
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayKey = yesterday.toISOString().split('T')[0];

                    if (dates[0] !== yesterdayKey) {
                        return 0; // Streak broken
                    }
                }

                let streak = 0;
                let currentDate = new Date(dates[0]);

                for (let i = 0; i < dates.length; i++) {
                    const expectedDate = new Date(currentDate);
                    expectedDate.setDate(currentDate.getDate() - i);
                    const expectedKey = expectedDate.toISOString().split('T')[0];

                    if (dates[i] === expectedKey) {
                        streak++;
                    } else {
                        break;
                    }
                }

                return streak;
            },

            // Get longest streak ever
            getLongestStreak() {
                const dailyTotals = this.getDailyTotals();
                const dates = Object.keys(dailyTotals).sort();

                if (dates.length === 0) return 0;

                let longestStreak = 0;
                let currentStreak = 1;

                for (let i = 1; i < dates.length; i++) {
                    const prevDate = new Date(dates[i - 1]);
                    const currDate = new Date(dates[i]);

                    const dayDiff = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));

                    if (dayDiff === 1) {
                        currentStreak++;
                    } else {
                        longestStreak = Math.max(longestStreak, currentStreak);
                        currentStreak = 1;
                    }
                }

                longestStreak = Math.max(longestStreak, currentStreak);
                return longestStreak;
            },

            // Get statistics for last N days
            getLastNDaysStats(days) {
                const dailyTotals = this.getDailyTotals();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const stats = [];
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateKey = date.toISOString().split('T')[0];

                    stats.push({
                        date: dateKey,
                        total: dailyTotals[dateKey] || 0
                    });
                }

                return stats;
            }
        };

        // ===== AUTH LOCK SCREEN MANAGER =====
        // Manages the first-launch authentication gate
        const AuthLockScreen = {
            STORAGE_KEY: 'pushupTrackerAuthState',
            authState: 'UNINITIALIZED', // UNINITIALIZED -> AUTH_REQUIRED -> AUTHENTICATED/LOCAL_ONLY
            authDecisionMade: false,

            // Check if user has previously made an auth decision
            checkAuthState() {
                const savedState = localStorage.getItem(this.STORAGE_KEY);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    this.authState = state.authState || 'UNINITIALIZED';
                    this.authDecisionMade = state.authDecisionMade || false;
                    return this.authState !== 'UNINITIALIZED';
                }
                return false;
            },

            // Save auth state to localStorage
            saveAuthState(authState, mode) {
                this.authState = authState;
                this.authDecisionMade = true;
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
                    authState: authState,
                    authDecisionMade: true,
                    mode: mode,
                    timestamp: new Date().toISOString()
                }));
            },

            // Initialize the lock screen
            init() {
                // Check if auth decision was already made
                const hasAuthState = this.checkAuthState();

                if (hasAuthState) {
                    // User has already made a decision - hide lock screen
                    this.hideLockScreen();
                    return false; // Don't show lock screen
                }

                // First launch - show lock screen and set up event listeners
                this.authState = 'AUTH_REQUIRED';
                this.setupEventListeners();
                this.showLockScreen();
                return true; // Lock screen is active
            },

            // Set up button event listeners
            setupEventListeners() {
                const googleBtn = document.getElementById('authBtnGoogle');
                const skipBtn = document.getElementById('authBtnSkip');
                const continueBtn = document.getElementById('authBtnContinue');

                googleBtn.addEventListener('click', () => this.handleGoogleSignIn());
                skipBtn.addEventListener('click', () => this.handleSkip());
                continueBtn.addEventListener('click', () => this.handleContinue());
            },

            // Handle Google Sign-In
            async handleGoogleSignIn() {
                try {
                    console.log('[AuthLockScreen] Starting Google sign-in...');

                    // Set up a callback for when sign-in completes
                    const originalCallback = GoogleSheetsSync.onSignInComplete;
                    GoogleSheetsSync.onSignInComplete = () => {
                        console.log('[AuthLockScreen] onSignInComplete callback triggered');
                        // Call original callback if it exists
                        if (originalCallback) {
                            originalCallback();
                        }
                        // Update lock screen UI
                        this.onAuthSuccess();
                    };

                    // Delegate to GoogleSheetsSync for actual authentication
                    await GoogleSheetsSync.signIn();
                    console.log('[AuthLockScreen] signIn() call completed');
                } catch (error) {
                    console.error('[AuthLockScreen] Google sign-in failed:', error);
                    alert('Sign-in failed. Please try again.');
                }
            },

            // Called after successful Google authentication
            onAuthSuccess() {
                console.log('[AuthLockScreen] onAuthSuccess called - updating UI');
                // Update UI to show user identity
                const identityBefore = document.getElementById('authIdentityBefore');
                const identityAfter = document.getElementById('authIdentityAfter');
                const googleBtn = document.getElementById('authBtnGoogle');
                const continueBtn = document.getElementById('authBtnContinue');

                // Hide "not signed in" state
                identityBefore.style.display = 'none';

                // Show signed-in user info
                const userName = document.getElementById('authUserName');
                const userPicture = document.getElementById('authUserPicture');
                const userInitial = document.getElementById('authUserInitial');

                userName.textContent = GoogleSheetsSync.userName || GoogleSheetsSync.userEmail;

                if (GoogleSheetsSync.userPicture) {
                    userPicture.src = GoogleSheetsSync.userPicture;
                    userPicture.style.display = 'block';
                    userInitial.style.display = 'none';
                } else if (GoogleSheetsSync.userName) {
                    userInitial.textContent = GoogleSheetsSync.userName.charAt(0).toUpperCase();
                    userInitial.style.display = 'block';
                    userPicture.style.display = 'none';
                }

                identityAfter.style.display = 'flex';
                identityAfter.style.flexDirection = 'column';
                identityAfter.style.alignItems = 'center';

                // Hide Google sign-in button
                googleBtn.style.display = 'none';

                // Enable Continue button
                continueBtn.disabled = false;

                // Save auth state
                this.saveAuthState('AUTHENTICATED', 'GOOGLE_SHEETS');
            },

            // Handle Skip (Local Mode)
            handleSkip() {
                const continueBtn = document.getElementById('authBtnContinue');
                const googleBtn = document.getElementById('authBtnGoogle');

                // Enable Continue button
                continueBtn.disabled = false;

                // Optionally hide Google button to confirm choice
                googleBtn.disabled = true;
                googleBtn.style.opacity = '0.4';

                // Save auth state
                this.saveAuthState('LOCAL_ONLY', 'LOCAL_ONLY');
            },

            // Handle Continue button
            handleContinue() {
                console.log('[AuthLockScreen] Continue button clicked, current auth state:', this.authState);
                // Hide lock screen and proceed to main app
                this.hideLockScreen();

                // Initialize the main app
                // The init() function will handle routing based on whether settings exist
                if (window.continueToApp) {
                    window.continueToApp();
                }
            },

            // Show lock screen
            showLockScreen() {
                const lockScreen = document.getElementById('authLockScreen');
                lockScreen.classList.remove('hidden');
            },

            // Hide lock screen
            hideLockScreen() {
                const lockScreen = document.getElementById('authLockScreen');
                lockScreen.classList.add('hidden');
            },

            // Reset auth state (for testing or sign-out)
            resetAuthState() {
                localStorage.removeItem(this.STORAGE_KEY);
                this.authState = 'UNINITIALIZED';
                this.authDecisionMade = false;
            }
        };

        // Google Sheets Sync Manager
        const GoogleSheetsSync = {
            STORAGE_KEY: 'pushupTrackerSyncSettings',
            QUEUE_KEY: 'pushupTrackerSyncQueue',
            isInitialized: false,
            isSignedIn: false,
            accessToken: null,
            tokenExpiresAt: null,
            spreadsheetId: null,
            userEmail: null,
            userId: null,
            userName: null,
            userPicture: null,
            isSyncing: false,
            onSignInComplete: null, // Callback for AuthLockScreen integration

            // Initialize Google API
            async init() {
                try {
                    await this.loadGoogleAPI();
                    await this.loadSettings();
                    this.isInitialized = true;
                    this.checkSignInStatus();
                    return true;
                } catch (error) {
                    console.error('Failed to initialize Google Sheets sync:', error);
                    this.updateSyncStatus('error', 'Failed to initialize sync', error.message);
                    return false;
                }
            },

            // Load Google API
            loadGoogleAPI() {
                return new Promise((resolve, reject) => {
                    if (typeof gapi === 'undefined') {
                        setTimeout(() => this.loadGoogleAPI().then(resolve).catch(reject), 100);
                        return;
                    }

                    gapi.load('client', async () => {
                        try {
                            await gapi.client.init({
                                apiKey: GOOGLE_CONFIG.API_KEY,
                                discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
                            });
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    });
                });
            },

            // Check if user is signed in
            checkSignInStatus() {
                console.log('[Auth] Checking sign-in status...');
                const settings = this.getSettings();
                console.log('[Auth] Settings loaded:', !!settings);
                if (settings && settings.accessToken) {
                    console.log('[Auth] Access token found, user is signed in');
                    this.accessToken = settings.accessToken;
                    this.tokenExpiresAt = settings.tokenExpiresAt;
                    this.spreadsheetId = settings.spreadsheetId;
                    this.userEmail = settings.userEmail;
                    this.userId = settings.userId;
                    this.userName = settings.userName;
                    this.userPicture = settings.userPicture;
                    this.isSignedIn = true;

                    // Check if token is expired
                    if (this.isTokenExpired()) {
                        this.updateSyncStatus('offline', 'Token expired', 'Please sign in again');
                        this.signOut();
                    } else {
                        this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, 'Ready to sync');
                    }
                    this.updateSyncUI();
                    this.updateUserAccountView(); // AC-AUTH-2.5: Update view on auth state change
                } else {
                    console.log('[Auth] No access token found, user is NOT signed in');
                    this.isSignedIn = false;
                    this.updateSyncStatus('offline', 'Not connected', 'Connect to Google Sheets to back up your data');
                    this.updateSyncUI();
                    this.updateUserAccountView(); // AC-AUTH-2.5: Update view on auth state change
                }
            },

            // Sign in with Google
            async signIn() {
                try {
                    console.log('[Auth] Starting sign-in process...');
                    console.log('[Auth] GOOGLE_CONFIG:', typeof GOOGLE_CONFIG !== 'undefined' ? 'defined' : 'undefined');
                    console.log('[Auth] google API:', typeof google !== 'undefined' ? 'loaded' : 'not loaded');
                    console.log('[Auth] gapi:', typeof gapi !== 'undefined' ? 'loaded' : 'not loaded');

                    if (typeof google === 'undefined') {
                        console.error('[Auth] Google Identity Services not loaded');
                        throw new Error('Google Identity Services not loaded');
                    }

                    if (typeof GOOGLE_CONFIG === 'undefined') {
                        console.error('[Auth] GOOGLE_CONFIG not defined');
                        throw new Error('GOOGLE_CONFIG not defined');
                    }

                    console.log('[Auth] Initializing token client...');
                    const client = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CONFIG.CLIENT_ID,
                        scope: GOOGLE_CONFIG.SCOPES,
                        callback: async (response) => {
                            console.log('[Auth] OAuth callback received');
                            if (response.error) {
                                console.error('[Auth] OAuth error:', response.error);
                                this.updateSyncStatus('error', 'Sign-in failed', response.error);
                                return;
                            }
                            console.log('[Auth] Access token received');

                            this.accessToken = response.access_token;
                            // Token expires in 1 hour (3600 seconds)
                            this.tokenExpiresAt = Date.now() + (response.expires_in || 3600) * 1000;

                            // Get user info
                            const userInfo = await this.getUserInfo();
                            this.userEmail = userInfo.email;
                            this.userId = userInfo.userId;
                            this.userName = userInfo.name;
                            this.userPicture = userInfo.picture;

                            // Check if user has existing data in the cloud
                            const hasLocalData = LogManager.getAllLogs().length > 0;
                            const existingSpreadsheet = await this.findUserSpreadsheet();

                            if (existingSpreadsheet) {
                                // User has existing spreadsheet
                                this.spreadsheetId = existingSpreadsheet;

                                if (hasLocalData) {
                                    // Ask user: merge or replace?
                                    await this.showSyncStrategyDialog();
                                } else {
                                    // No local data, just restore from cloud
                                    await this.restoreFromCloud();
                                }
                            } else {
                                // No existing spreadsheet, create new one
                                await this.ensureSpreadsheet();

                                if (hasLocalData) {
                                    // Upload local data to new spreadsheet
                                    await this.performFullSync();
                                }
                            }

                            // Save settings
                            this.saveSettings({
                                accessToken: this.accessToken,
                                tokenExpiresAt: this.tokenExpiresAt,
                                spreadsheetId: this.spreadsheetId,
                                userEmail: this.userEmail,
                                userId: this.userId,
                                userName: this.userName,
                                userPicture: this.userPicture,
                                lastSynced: null
                            });

                            this.isSignedIn = true;
                            this.updateSyncUI();
                            this.updateUserAccountView(); // AC-AUTH-2.5: Update view on auth state change

                            showSuccessMessage('âœ… Successfully connected to Google Sheets!');

                            // Trigger callback for AuthLockScreen (if set)
                            if (typeof this.onSignInComplete === 'function') {
                                this.onSignInComplete();
                            }
                        },
                    });

                    console.log('[Auth] Requesting access token...');
                    client.requestAccessToken();
                    console.log('[Auth] Access token request initiated');
                } catch (error) {
                    console.error('[Auth] Sign-in error:', error);
                    console.error('[Auth] Error details:', error.message, error.stack);
                    this.updateSyncStatus('error', 'Sign-in failed', error.message);
                    alert('Sign-in failed: ' + error.message);
                }
            },

            // Get user info
            async getUserInfo() {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`
                    }
                });
                const userInfo = await response.json();
                return {
                    email: userInfo.email,
                    userId: userInfo.id, // Google account ID (unique identifier)
                    name: userInfo.name,
                    picture: userInfo.picture
                };
            },

            // Sign out
            signOut() {
                this.accessToken = null;
                this.tokenExpiresAt = null;
                this.spreadsheetId = null;
                this.userEmail = null;
                this.userId = null;
                this.userName = null;
                this.userPicture = null;
                this.isSignedIn = false;
                localStorage.removeItem(this.STORAGE_KEY);

                // AC-LOGIN-1.22: Reset auth state so lock screen appears on next launch
                if (typeof AuthLockScreen !== 'undefined') {
                    AuthLockScreen.resetAuthState();
                }

                this.updateSyncStatus('offline', 'Not connected', 'Connect to Google Sheets to back up your data');
                this.updateSyncUI();
                this.updateUserAccountView(); // AC-AUTH-2.5: Update view on auth state change
                showSuccessMessage('âœ… Disconnected from Google Sheets. You will see the login screen on next launch.');
            },

            // Check if access token is expired
            isTokenExpired() {
                if (!this.tokenExpiresAt) return true;
                // Add 5 minute buffer before actual expiration
                return Date.now() >= (this.tokenExpiresAt - 5 * 60 * 1000);
            },

            // Refresh access token
            async refreshToken() {
                if (!this.isSignedIn) return false;

                try {
                    // Request a new access token
                    return new Promise((resolve) => {
                        const client = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CONFIG.CLIENT_ID,
                            scope: GOOGLE_CONFIG.SCOPES,
                            callback: (response) => {
                                if (response.error) {
                                    console.error('Token refresh failed:', response.error);
                                    this.signOut();
                                    resolve(false);
                                    return;
                                }

                                this.accessToken = response.access_token;
                                this.tokenExpiresAt = Date.now() + (response.expires_in || 3600) * 1000;

                                // Update settings
                                const settings = this.getSettings();
                                if (settings) {
                                    settings.accessToken = this.accessToken;
                                    settings.tokenExpiresAt = this.tokenExpiresAt;
                                    this.saveSettings(settings);
                                }

                                console.log('Token refreshed successfully');
                                resolve(true);
                            },
                        });

                        // Request token silently (no UI)
                        client.requestAccessToken({ prompt: '' });
                    });
                } catch (error) {
                    console.error('Failed to refresh token:', error);
                    return false;
                }
            },

            // Ensure valid token before API calls
            async ensureValidToken() {
                if (this.isTokenExpired()) {
                    const refreshed = await this.refreshToken();
                    if (!refreshed) {
                        throw new Error('Token expired. Please sign in again.');
                    }
                }
            },

            // Find existing spreadsheet for this user
            async findUserSpreadsheet() {
                try {
                    await this.ensureValidToken();

                    // Search for spreadsheets with the user's ID in the name or content
                    // First, try to find by searching Drive for files created by this app
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.spreadsheet' and name contains 'Pushup Tracker'&orderBy=createdTime desc`,
                        {
                            headers: {
                                'Authorization': `Bearer ${this.accessToken}`,
                            }
                        }
                    );

                    const data = await response.json();

                    if (data.files && data.files.length > 0) {
                        // Check each spreadsheet for user ID in the data
                        for (const file of data.files) {
                            try {
                                const sheetResponse = await fetch(
                                    `https://sheets.googleapis.com/v4/spreadsheets/${file.id}/values/Push-up Logs!B2:B`,
                                    {
                                        headers: {
                                            'Authorization': `Bearer ${this.accessToken}`,
                                        }
                                    }
                                );
                                const sheetData = await sheetResponse.json();

                                // Check if any row has this user's ID
                                if (sheetData.values && sheetData.values.some(row => row[0] === this.userId)) {
                                    console.log(`Found existing spreadsheet for user: ${file.id}`);
                                    return file.id;
                                }
                            } catch (err) {
                                // Sheet might not have the right structure, skip it
                                console.log(`Skipping sheet ${file.id}: ${err.message}`);
                                continue;
                            }
                        }
                    }

                    return null;
                } catch (error) {
                    console.error('Error finding user spreadsheet:', error);
                    return null;
                }
            },

            // Restore data from Google Sheets
            async restoreFromCloud() {
                try {
                    await this.ensureValidToken();

                    this.updateSyncStatus('syncing', 'Restoring data...', 'Downloading from Google Sheets');

                    const rows = await this.getAllRows();

                    if (!rows || rows.length === 0) {
                        this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, 'No data to restore');
                        return;
                    }

                    // Convert rows to log entries, filtering by user ID
                    const logs = rows
                        .filter(row => row[1] === this.userId) // Only restore this user's data
                        .map(row => {
                            const timestamp = new Date(`${row[2]} ${row[3]}`).toISOString();
                            return {
                                id: parseInt(row[0]),
                                amount: parseInt(row[4]),
                                timestamp: timestamp
                            };
                        })
                        .sort((a, b) => a.timestamp.localeCompare(b.timestamp));

                    // Save to local storage
                    LogManager.save(logs);

                    // Update UI
                    displayLogHistory();
                    updateTodayTotal();
                    updateProgressTracking();
                    updateStatistics();
                    updateGamification();

                    this.updateLastSyncTime();
                    this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, `Restored ${logs.length} entries`);
                    showSuccessMessage(`âœ… Restored ${logs.length} push-up entries from Google Sheets`);
                } catch (error) {
                    console.error('Failed to restore from cloud:', error);
                    this.updateSyncStatus('error', 'Restore failed', error.message);
                    throw error;
                }
            },

            // Show dialog to choose sync strategy
            async showSyncStrategyDialog() {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        padding: 20px;
                    `;

                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        background: white;
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 500px;
                        width: 100%;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    `;

                    const localCount = LogManager.getAllLogs().length;

                    dialog.innerHTML = `
                        <h2 style="color: #667eea; margin-bottom: 16px; font-size: 1.5em;">Data Sync Strategy</h2>
                        <p style="margin-bottom: 20px; color: #555; line-height: 1.6;">
                            You have <strong>${localCount} entries</strong> on this device and existing data in Google Sheets.
                            How would you like to proceed?
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button id="mergeBtn" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 14px 20px;
                                border-radius: 10px;
                                font-size: 1em;
                                font-weight: 600;
                                cursor: pointer;
                                transition: transform 0.2s;
                            ">
                                ðŸ”„ Merge Local and Cloud Data
                            </button>
                            <button id="replaceBtn" style="
                                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                                color: white;
                                border: none;
                                padding: 14px 20px;
                                border-radius: 10px;
                                font-size: 1em;
                                font-weight: 600;
                                cursor: pointer;
                                transition: transform 0.2s;
                            ">
                                â˜ï¸ Replace Local with Cloud Data
                            </button>
                            <button id="cancelBtn" style="
                                background: #e0e0e0;
                                color: #666;
                                border: none;
                                padding: 14px 20px;
                                border-radius: 10px;
                                font-size: 1em;
                                font-weight: 600;
                                cursor: pointer;
                                transition: transform 0.2s;
                            ">
                                Cancel
                            </button>
                        </div>
                        <p style="margin-top: 16px; font-size: 0.85em; color: #888; line-height: 1.4;">
                            <strong>Merge:</strong> Combines local and cloud data, removing duplicates.<br>
                            <strong>Replace:</strong> Discards local data and restores from cloud.
                        </p>
                    `;

                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);

                    const cleanup = () => {
                        document.body.removeChild(overlay);
                    };

                    document.getElementById('mergeBtn').addEventListener('click', async () => {
                        cleanup();
                        await this.mergeLocalAndCloudData();
                        resolve('merge');
                    });

                    document.getElementById('replaceBtn').addEventListener('click', async () => {
                        cleanup();
                        await this.restoreFromCloud();
                        resolve('replace');
                    });

                    document.getElementById('cancelBtn').addEventListener('click', () => {
                        cleanup();
                        this.signOut();
                        resolve('cancel');
                    });
                });
            },

            // Merge local and cloud data
            async mergeLocalAndCloudData() {
                try {
                    await this.ensureValidToken();

                    this.updateSyncStatus('syncing', 'Merging data...', 'Combining local and cloud data');

                    // Get cloud data
                    const rows = await this.getAllRows();
                    const cloudLogs = rows
                        .filter(row => row[1] === this.userId)
                        .map(row => {
                            const timestamp = new Date(`${row[2]} ${row[3]}`).toISOString();
                            return {
                                id: parseInt(row[0]),
                                amount: parseInt(row[4]),
                                timestamp: timestamp
                            };
                        });

                    // Get local data
                    const localLogs = LogManager.getAllLogs();

                    // Merge using conflict resolution
                    const merged = this.mergeWithConflictResolution(localLogs, cloudLogs);

                    // Save merged data locally
                    LogManager.save(merged);

                    // Update cloud with merged data
                    await this.performFullSync();

                    // Update UI
                    displayLogHistory();
                    updateTodayTotal();
                    updateProgressTracking();
                    updateStatistics();
                    updateGamification();

                    this.updateLastSyncTime();
                    this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, `Merged ${merged.length} total entries`);
                    showSuccessMessage(`âœ… Merged data successfully: ${merged.length} total entries`);
                } catch (error) {
                    console.error('Failed to merge data:', error);
                    this.updateSyncStatus('error', 'Merge failed', error.message);
                    throw error;
                }
            },

            // Merge with conflict resolution using timestamps
            mergeWithConflictResolution(localLogs, cloudLogs) {
                const logMap = new Map();

                // Add all local logs
                localLogs.forEach(log => {
                    logMap.set(log.id, { ...log, source: 'local' });
                });

                // Add/update with cloud logs
                cloudLogs.forEach(cloudLog => {
                    const existingLog = logMap.get(cloudLog.id);

                    if (!existingLog) {
                        // New entry from cloud
                        logMap.set(cloudLog.id, { ...cloudLog, source: 'cloud' });
                    } else {
                        // Conflict: use most recent timestamp
                        const localTime = new Date(existingLog.timestamp).getTime();
                        const cloudTime = new Date(cloudLog.timestamp).getTime();

                        if (cloudTime > localTime) {
                            logMap.set(cloudLog.id, { ...cloudLog, source: 'cloud' });
                        }
                        // If local is newer or same, keep local (already in map)
                    }
                });

                // Convert map to sorted array
                return Array.from(logMap.values())
                    .map(log => {
                        const { source, ...cleanLog } = log;
                        return cleanLog;
                    })
                    .sort((a, b) => a.timestamp.localeCompare(b.timestamp));
            },

            // Save sync settings
            saveSettings(settings) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
            },

            // Load sync settings
            getSettings() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : null;
            },

            loadSettings() {
                const settings = this.getSettings();
                if (settings) {
                    this.accessToken = settings.accessToken;
                    this.tokenExpiresAt = settings.tokenExpiresAt;
                    this.spreadsheetId = settings.spreadsheetId;
                    this.userEmail = settings.userEmail;
                    this.userId = settings.userId;
                    this.userName = settings.userName;
                    this.userPicture = settings.userPicture;
                    this.isSignedIn = !!settings.accessToken;
                }
            },

            // Create or get spreadsheet
            async ensureSpreadsheet() {
                try {
                    // Create a new spreadsheet
                    const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            properties: {
                                title: `Pushup Tracker - ${new Date().toLocaleDateString()}`
                            },
                            sheets: [{
                                properties: {
                                    title: 'Push-up Logs',
                                    gridProperties: {
                                        frozenRowCount: 1
                                    }
                                }
                            }]
                        })
                    });

                    const spreadsheet = await response.json();
                    this.spreadsheetId = spreadsheet.spreadsheetId;

                    // Add header row
                    await this.updateSheet('Push-up Logs!A1:E1', [
                        ['ID', 'User ID', 'Date', 'Time', 'Amount']
                    ]);

                    // Format header row
                    await this.formatHeader();

                    return this.spreadsheetId;
                } catch (error) {
                    console.error('Failed to create spreadsheet:', error);
                    throw error;
                }
            },

            // Format header row
            async formatHeader() {
                try {
                    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}:batchUpdate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            requests: [{
                                repeatCell: {
                                    range: {
                                        sheetId: 0,
                                        startRowIndex: 0,
                                        endRowIndex: 1
                                    },
                                    cell: {
                                        userEnteredFormat: {
                                            backgroundColor: { red: 0.4, green: 0.49, blue: 0.91 },
                                            textFormat: {
                                                foregroundColor: { red: 1, green: 1, blue: 1 },
                                                fontSize: 11,
                                                bold: true
                                            }
                                        }
                                    },
                                    fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                }
                            }]
                        })
                    });
                } catch (error) {
                    console.error('Failed to format header:', error);
                }
            },

            // Update sheet with values
            async updateSheet(range, values) {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${range}?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ values })
                    }
                );
                return await response.json();
            },

            // Append rows to sheet
            async appendRows(values) {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/Push-up Logs!A:E:append?valueInputOption=RAW`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ values })
                    }
                );
                return await response.json();
            },

            // Get all rows from sheet
            async getAllRows() {
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/Push-up Logs!A2:E`,
                        {
                            headers: {
                                'Authorization': `Bearer ${this.accessToken}`,
                            }
                        }
                    );
                    const data = await response.json();
                    return data.values || [];
                } catch (error) {
                    console.error('Failed to get rows:', error);
                    return [];
                }
            },

            // Perform full sync (bidirectional: download from cloud, then upload local changes)
            async performFullSync() {
                if (!this.isSignedIn || !this.spreadsheetId) {
                    return;
                }

                this.isSyncing = true;
                this.updateSyncStatus('syncing', 'Syncing...', 'Syncing data with Google Sheets');

                try {
                    await this.ensureValidToken();

                    // Step 1: Download data from Google Sheets and merge with local
                    const existingRows = await this.getAllRows();
                    console.log('[Sync] Fetched rows from sheet:', existingRows?.length || 0);
                    console.log('[Sync] Current userId:', this.userId);
                    if (existingRows && existingRows.length > 0) {
                        console.log('[Sync] Sample row:', existingRows[0]);
                    }

                    if (existingRows && existingRows.length > 0) {
                        // Convert cloud rows to log entries, filtering by user ID
                        const cloudLogs = existingRows
                            .filter(row => row[1] === this.userId)
                            .map(row => {
                                const timestamp = new Date(`${row[2]} ${row[3]}`).toISOString();
                                return {
                                    id: parseInt(row[0]),
                                    amount: parseInt(row[4]),
                                    timestamp: timestamp
                                };
                            });

                        console.log('[Sync] Cloud logs for this user:', cloudLogs.length);
                        if (cloudLogs.length > 0) {
                            console.log('[Sync] Sample cloud log:', cloudLogs[0]);
                        }

                        // Get local data
                        const localLogs = LogManager.getAllLogs();
                        console.log('[Sync] Local logs before merge:', localLogs.length);

                        // Merge cloud and local data
                        const mergedLogs = this.mergeWithConflictResolution(localLogs, cloudLogs);
                        console.log('[Sync] Merged logs:', mergedLogs.length);

                        // Update local storage with merged data
                        LogManager.save(mergedLogs);
                        console.log('[Sync] Saved merged data to local storage');

                        // Verify what was saved
                        const verifyLogs = LogManager.getAllLogs();
                        console.log('[Sync] Verification - logs in storage after save:', verifyLogs.length);
                        if (verifyLogs.length > 0) {
                            console.log('[Sync] Sample log from storage:', verifyLogs[0]);
                        }
                    }

                    // Step 2: Upload any new local entries to Google Sheets
                    const logs = LogManager.getAllLogs();
                    console.log('[Sync] Logs after merge for upload check:', logs.length);

                    if (logs.length === 0) {
                        console.log('[Sync] No logs to sync, finishing');
                        this.updateLastSyncTime();
                        this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, 'All data synced');
                        this.isSyncing = false;
                        return;
                    }

                    // Get fresh sheet data after merge
                    const freshRows = await this.getAllRows();
                    const existingIds = new Set(freshRows.map(row => row[0]));

                    // Prepare rows to add (only new entries not in cloud)
                    const rowsToAdd = logs
                        .filter(log => !existingIds.has(log.id.toString()))
                        .map(log => this.logToRow(log));

                    if (rowsToAdd.length > 0) {
                        await this.appendRows(rowsToAdd);
                    }

                    // Process pending queue
                    await this.processPendingQueue();

                    this.updateLastSyncTime();
                    this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, `Synced ${logs.length} entries`);
                } catch (error) {
                    console.error('Full sync failed:', error);
                    this.updateSyncStatus('error', 'Sync failed', error.message);
                } finally {
                    this.isSyncing = false;
                }
            },

            // Convert log entry to spreadsheet row
            logToRow(log) {
                const date = new Date(log.timestamp);
                return [
                    log.id.toString(),
                    this.userId || '',
                    date.toLocaleDateString('en-US'),
                    date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                    log.amount.toString()
                ];
            },

            // Queue operations for offline sync
            queueOperation(operation, logId, data = null, extraData = null) {
                const queue = this.getQueue();
                queue.push({
                    operation,
                    logId,
                    data,
                    extraData,
                    timestamp: new Date().toISOString()
                });
                this.saveQueue(queue);
                this.updatePendingCount();
            },

            getQueue() {
                const data = localStorage.getItem(this.QUEUE_KEY);
                return data ? JSON.parse(data) : [];
            },

            saveQueue(queue) {
                localStorage.setItem(this.QUEUE_KEY, JSON.stringify(queue));
            },

            clearQueue() {
                localStorage.removeItem(this.QUEUE_KEY);
                this.updatePendingCount();
            },

            // Process pending queue
            async processPendingQueue() {
                const queue = this.getQueue();
                if (queue.length === 0) {
                    console.log('No pending operations to sync');
                    return;
                }

                console.log(`Processing ${queue.length} pending operations...`);
                this.updateSyncStatus('syncing', 'Syncing...', `Processing ${queue.length} pending changes`);

                const successfulItems = [];
                const failedItems = [];

                for (let i = 0; i < queue.length; i++) {
                    const item = queue[i];
                    try {
                        if (item.operation === 'add') {
                            const log = LogManager.getAllLogs().find(l => l.id === item.logId);
                            if (log) {
                                await this.appendRows([this.logToRow(log)]);
                                successfulItems.push(item);
                                console.log(`âœ“ Synced add operation for log ${item.logId}`);
                            } else {
                                // Log no longer exists locally, remove from queue
                                successfulItems.push(item);
                                console.log(`âœ“ Skipped add operation (log no longer exists): ${item.logId}`);
                            }
                        } else if (item.operation === 'edit') {
                            await this.updateLogInSheet(item.logId, item.data, item.extraData || null);
                            successfulItems.push(item);
                            console.log(`âœ“ Synced edit operation for log ${item.logId}`);
                        } else if (item.operation === 'delete') {
                            await this.deleteLogFromSheet(item.logId);
                            successfulItems.push(item);
                            console.log(`âœ“ Synced delete operation for log ${item.logId}`);
                        }
                    } catch (error) {
                        console.error(`âœ— Failed to process ${item.operation} for log ${item.logId}:`, error);
                        failedItems.push(item);

                        // If we hit a network error, stop processing and keep remaining items
                        if (!navigator.onLine || error.message.includes('Failed to fetch')) {
                            console.log('Network error detected, stopping queue processing');
                            // Add remaining items to failed items
                            failedItems.push(...queue.slice(i + 1));
                            break;
                        }
                    }
                }

                // Update queue with only failed items
                if (failedItems.length > 0) {
                    this.saveQueue(failedItems);
                    this.updatePendingCount();
                    this.updateSyncStatus('error', 'Partial sync', `${failedItems.length} changes still pending`);
                    showSuccessMessage(`âš ï¸ Synced ${successfulItems.length} of ${queue.length} changes`);
                } else {
                    this.clearQueue();
                    this.updateLastSyncTime();
                    this.updateSyncStatus('synced', `Connected as ${this.userEmail}`, 'All changes synced');
                    showSuccessMessage(`âœ… Successfully synced ${successfulItems.length} changes`);
                }
            },

            // Update a log entry in the sheet
            async updateLogInSheet(logId, newAmount, newTimestamp = null) {
                try {
                    const rows = await this.getAllRows();
                    const rowIndex = rows.findIndex(row => row[0] === logId.toString());

                    if (rowIndex !== -1) {
                        const actualRow = rowIndex + 2; // +1 for header, +1 for 0-index

                        if (newTimestamp) {
                            // Update amount, date, and time columns
                            const timestamp = new Date(newTimestamp);
                            const dateStr = timestamp.toLocaleDateString('en-US', { timeZone: 'UTC' });
                            const timeStr = timestamp.toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true,
                                timeZone: 'UTC'
                            });

                            // Update columns B (Date), C (Time), and D (Amount)
                            await this.updateSheet(`Push-up Logs!B${actualRow}:D${actualRow}`, [
                                [dateStr, timeStr, newAmount.toString()]
                            ]);
                        } else {
                            // Update only amount column (D)
                            await this.updateSheet(`Push-up Logs!D${actualRow}`, [[newAmount.toString()]]);
                        }
                    }
                } catch (error) {
                    console.error('Failed to update log in sheet:', error);
                    throw error;
                }
            },

            // Delete a log entry from the sheet
            async deleteLogFromSheet(logId) {
                try {
                    const rows = await this.getAllRows();
                    const rowIndex = rows.findIndex(row => row[0] === logId.toString());

                    if (rowIndex !== -1) {
                        const actualRow = rowIndex + 1; // +1 for 0-index (header already excluded)

                        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}:batchUpdate`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.accessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                requests: [{
                                    deleteDimension: {
                                        range: {
                                            sheetId: 0,
                                            dimension: 'ROWS',
                                            startIndex: actualRow,
                                            endIndex: actualRow + 1
                                        }
                                    }
                                }]
                            })
                        });
                    }
                } catch (error) {
                    console.error('Failed to delete log from sheet:', error);
                    throw error;
                }
            },

            // Sync operations
            async syncAdd(log) {
                // Queue if not signed in or offline
                if (!this.isSignedIn) {
                    this.queueOperation('add', log.id);
                    return;
                }

                if (!navigator.onLine) {
                    console.log('Offline: Queuing add operation');
                    this.queueOperation('add', log.id);
                    this.updatePendingCount();
                    return;
                }

                try {
                    await this.ensureValidToken();
                    await this.appendRows([this.logToRow(log)]);
                    this.updateLastSyncTime();
                    console.log('Successfully synced new log entry');
                } catch (error) {
                    console.error('Failed to sync add:', error);
                    this.queueOperation('add', log.id);
                    this.updatePendingCount();
                }
            },

            async syncEdit(logId, newAmount, newTimestamp = null) {
                // Queue if not signed in or offline
                if (!this.isSignedIn) {
                    this.queueOperation('edit', logId, newAmount, newTimestamp);
                    return;
                }

                if (!navigator.onLine) {
                    console.log('Offline: Queuing edit operation');
                    this.queueOperation('edit', logId, newAmount, newTimestamp);
                    this.updatePendingCount();
                    return;
                }

                try {
                    await this.ensureValidToken();
                    await this.updateLogInSheet(logId, newAmount, newTimestamp);
                    this.updateLastSyncTime();
                    console.log('Successfully synced edit');
                } catch (error) {
                    console.error('Failed to sync edit:', error);
                    this.queueOperation('edit', logId, newAmount, newTimestamp);
                    this.updatePendingCount();
                }
            },

            async syncDelete(logId) {
                // Queue if not signed in or offline
                if (!this.isSignedIn) {
                    this.queueOperation('delete', logId);
                    return;
                }

                if (!navigator.onLine) {
                    console.log('Offline: Queuing delete operation');
                    this.queueOperation('delete', logId);
                    this.updatePendingCount();
                    return;
                }

                try {
                    await this.ensureValidToken();
                    await this.deleteLogFromSheet(logId);
                    this.updateLastSyncTime();
                    console.log('Successfully synced delete');
                } catch (error) {
                    console.error('Failed to sync delete:', error);
                    this.queueOperation('delete', logId);
                    this.updatePendingCount();
                }
            },

            // Update last sync time
            updateLastSyncTime() {
                const settings = this.getSettings();
                if (settings) {
                    settings.lastSynced = new Date().toISOString();
                    this.saveSettings(settings);
                    this.updateSyncUI();
                    this.updateUserAccountView(); // AC-AUTH-2.5: Update view on sync
                }
            },

            // Update sync status UI
            updateSyncStatus(status, mainText, subText) {
                const container = document.getElementById('syncStatus');
                const icon = document.getElementById('syncStatusIcon');
                const main = document.getElementById('syncStatusMain');
                const sub = document.getElementById('syncStatusSub');

                // If elements don't exist, skip (old UI removed)
                if (!container || !icon || !main || !sub) {
                    console.log('[Sync] Legacy sync status elements not found, skipping updateSyncStatus');
                    return;
                }

                // Remove all status classes
                container.classList.remove('syncing', 'synced', 'error', 'offline');

                // Add current status class
                if (status !== 'none') {
                    container.classList.add(status);
                }

                // Update icon
                const icons = {
                    syncing: 'ðŸ”„',
                    synced: 'âœ…',
                    error: 'âŒ',
                    offline: 'â˜ï¸'
                };
                icon.textContent = icons[status] || 'â˜ï¸';

                // Update text
                main.textContent = mainText;
                sub.textContent = subText;
            },

            // Update sync UI elements
            updateSyncUI() {
                const signInBtn = document.getElementById('googleSignInBtn');
                const syncBtn = document.getElementById('manualSyncBtn');
                const settingsCard = document.getElementById('syncSettingsCard');
                const connectedAccount = document.getElementById('connectedAccount');
                const sheetName = document.getElementById('sheetName');
                const lastSynced = document.getElementById('lastSynced');

                // If legacy elements don't exist, skip (UI has been updated)
                if (!signInBtn && !syncBtn && !settingsCard) {
                    console.log('[Sync] Legacy sync UI elements not found, skipping updateSyncUI');
                    return;
                }

                if (this.isSignedIn) {
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (syncBtn) syncBtn.style.display = 'block';
                    if (settingsCard) settingsCard.style.display = 'block';

                    if (connectedAccount) connectedAccount.textContent = this.userEmail || '-';

                    if (this.spreadsheetId && sheetName) {
                        const settings = this.getSettings();
                        sheetName.innerHTML = `<a href="https://docs.google.com/spreadsheets/d/${this.spreadsheetId}" target="_blank" style="color: #667eea; text-decoration: none;">Open Sheet â†—</a>`;

                        if (settings && settings.lastSynced && lastSynced) {
                            const syncDate = new Date(settings.lastSynced);
                            lastSynced.textContent = this.formatRelativeTime(syncDate);
                        } else if (lastSynced) {
                            lastSynced.textContent = 'Never';
                        }
                    }
                } else {
                    if (signInBtn) signInBtn.style.display = 'block';
                    if (syncBtn) syncBtn.style.display = 'none';
                    if (settingsCard) settingsCard.style.display = 'none';
                }

                this.updatePendingCount();
            },

            // Update pending changes count
            updatePendingCount() {
                const queue = this.getQueue();
                const pendingEl = document.getElementById('pendingChanges');
                const pendingElNew = document.getElementById('pendingChangesNew');

                if (pendingEl) {
                    pendingEl.textContent = queue.length;
                    if (queue.length > 0) {
                        pendingEl.style.color = '#f5576c';
                        pendingEl.style.fontWeight = '700';
                    } else {
                        pendingEl.style.color = '';
                        pendingEl.style.fontWeight = '';
                    }
                }

                if (pendingElNew) {
                    pendingElNew.textContent = queue.length;
                    if (queue.length > 0) {
                        pendingElNew.style.color = '#f5576c';
                        pendingElNew.style.fontWeight = '700';
                    } else {
                        pendingElNew.style.color = '';
                        pendingElNew.style.fontWeight = '';
                    }
                }
            },

            // Update User Account View (AC-AUTH-2.1 to AC-AUTH-2.6)
            updateUserAccountView() {
                console.log('[UI] Updating user account view, isSignedIn:', this.isSignedIn);
                const userAccountContainer = document.getElementById('userAccountContainer');
                const loggedInView = document.getElementById('loggedInView');
                const localOnlyView = document.getElementById('localOnlyView');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                const syncModeSubtitle = document.getElementById('syncModeSubtitle');
                const lastSyncedNew = document.getElementById('lastSyncedNew');
                const viewSheetBtn = document.getElementById('viewSheetBtn');

                console.log('[UI] Elements found:', {
                    userAccountContainer: !!userAccountContainer,
                    loggedInView: !!loggedInView,
                    localOnlyView: !!localOnlyView
                });

                // Show the container
                if (userAccountContainer) {
                    userAccountContainer.classList.remove('hidden');
                    console.log('[UI] User account container shown');
                }

                if (this.isSignedIn) {
                    console.log('[UI] Showing logged in view');
                    // AC-AUTH-2.1: Display user's Google account (name or email)
                    // AC-AUTH-2.2: Indicate Google sync is active
                    loggedInView.style.display = 'block';
                    localOnlyView.style.display = 'none';

                    // Update user info
                    if (this.userName) {
                        userName.textContent = this.userName;
                    } else if (this.userEmail) {
                        userName.textContent = this.userEmail.split('@')[0];
                    }

                    if (this.userEmail) {
                        userEmail.textContent = this.userEmail;
                    }

                    // Update avatar
                    if (this.userPicture) {
                        userAvatar.innerHTML = `<img src="${this.userPicture}" alt="Profile" />`;
                    } else if (this.userName) {
                        userAvatar.textContent = this.userName.charAt(0).toUpperCase();
                    } else {
                        userAvatar.textContent = 'ðŸ‘¤';
                    }

                    // Update sync status
                    const settings = this.getSettings();
                    if (settings && settings.lastSynced) {
                        const syncDate = new Date(settings.lastSynced);
                        lastSyncedNew.textContent = this.formatRelativeTime(syncDate);
                        syncModeSubtitle.textContent = `Last synced ${this.formatRelativeTime(syncDate)}`;
                    } else {
                        lastSyncedNew.textContent = 'Never';
                        syncModeSubtitle.textContent = 'Your data is backed up to Google Sheets';
                    }

                    // Update View Spreadsheet button
                    if (this.spreadsheetId) {
                        viewSheetBtn.style.display = 'block';
                        viewSheetBtn.onclick = () => {
                            window.open(`https://docs.google.com/spreadsheets/d/${this.spreadsheetId}`, '_blank');
                        };
                    } else {
                        viewSheetBtn.style.display = 'none';
                    }

                    this.updatePendingCount();
                } else {
                    console.log('[UI] Showing local only view with sign-in button');
                    // AC-AUTH-2.4: Indicate local-only mode when signed out
                    loggedInView.style.display = 'none';
                    localOnlyView.style.display = 'block';
                    console.log('[UI] localOnlyView display set to block');
                }
            },

            // Format relative time
            formatRelativeTime(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
                return date.toLocaleDateString();
            }
        };

        // Badge definitions
        const BADGES = [
            { id: 'first_step', icon: 'ðŸ‘¶', name: 'First Step', description: '1 push-up', threshold: 1 },
            { id: 'getting_started', icon: 'ðŸŽ¯', name: 'Getting Started', description: '10 push-ups', threshold: 10 },
            { id: 'half_century', icon: 'â­', name: 'Half Century', description: '50 push-ups', threshold: 50 },
            { id: 'centurion', icon: 'ðŸ’¯', name: 'Centurion', description: '100 push-ups', threshold: 100 },
            { id: 'quarter_master', icon: 'ðŸŽ–ï¸', name: 'Quarter Master', description: '250 push-ups', threshold: 250 },
            { id: 'half_way', icon: 'ðŸ…', name: 'Half Way', description: '500 push-ups', threshold: 500 },
            { id: 'warrior', icon: 'âš”ï¸', name: 'Warrior', description: '1,000 push-ups', threshold: 1000 },
            { id: 'champion', icon: 'ðŸ†', name: 'Champion', description: '2,500 push-ups', threshold: 2500 },
            { id: 'legend', icon: 'ðŸ‘‘', name: 'Legend', description: '5,000 push-ups', threshold: 5000 },
            { id: 'immortal', icon: 'ðŸ’Ž', name: 'Immortal', description: '10,000 push-ups', threshold: 10000 },
            { id: 'streak_3', icon: 'ðŸ”¥', name: '3-Day Streak', description: '3 days in a row', threshold: 3, type: 'streak' },
            { id: 'streak_7', icon: 'ðŸŒŸ', name: 'Week Warrior', description: '7 days in a row', threshold: 7, type: 'streak' },
            { id: 'streak_14', icon: 'ðŸ’ª', name: 'Two Weeks Strong', description: '14 days in a row', threshold: 14, type: 'streak' },
            { id: 'streak_30', icon: 'ðŸš€', name: 'Month Champion', description: '30 days in a row', threshold: 30, type: 'streak' },
            { id: 'streak_100', icon: 'ðŸŒˆ', name: 'Unstoppable', description: '100 days in a row', threshold: 100, type: 'streak' }
        ];

        // DOM elements
        const settingsCard = document.getElementById('settingsCard');
        const dashboardCard = document.getElementById('dashboardCard');
        const gamificationCard = document.getElementById('gamificationCard');
        const progressCard = document.getElementById('progressCard');
        const logCard = document.getElementById('logCard');
        const historyCard = document.getElementById('historyCard');
        const settingsForm = document.getElementById('settingsForm');
        const targetInput = document.getElementById('targetInput');
        const endDateInput = document.getElementById('endDateInput');
        const targetError = document.getElementById('targetError');
        const dateError = document.getElementById('dateError');
        const successMessage = document.getElementById('successMessage');
        const editSettingsBtn = document.getElementById('editSettingsBtn');

        // Dashboard elements
        const targetDisplay = document.getElementById('targetDisplay');
        const endDateDisplay = document.getElementById('endDateDisplay');
        const daysRemainingDisplay = document.getElementById('daysRemainingDisplay');
        const dailyPaceDisplay = document.getElementById('dailyPaceDisplay');
        const daysRemainingRow = document.getElementById('daysRemainingRow');
        const dailyPaceRow = document.getElementById('dailyPaceRow');

        // Progress elements
        const progressBarFill = document.getElementById('progressBarFill');
        const progressBarText = document.getElementById('progressBarText');
        const totalCompleted = document.getElementById('totalCompleted');
        const totalRemaining = document.getElementById('totalRemaining');
        const projectionDate = document.getElementById('projectionDate');
        const projectionNote = document.getElementById('projectionNote');
        const projectionBox = document.getElementById('projectionBox');

        // Log elements
        const todayTotal = document.getElementById('todayTotal');
        const quickAddButtons = document.querySelectorAll('.btn-quick-add');
        const customAmountInput = document.getElementById('customAmount');
        const logCustomBtn = document.getElementById('logCustomBtn');
        const logError = document.getElementById('logError');

        // History elements
        const historyList = document.getElementById('historyList');

        // Statistics elements
        const statisticsCard = document.getElementById('statisticsCard');
        const statsTabs = document.querySelectorAll('.stats-tab');
        const statsTabContents = document.querySelectorAll('.stats-tab-content');

        // Chart helper functions
        function drawBarChart(canvas, data, options = {}) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            ctx.clearRect(0, 0, width, height);

            if (data.length === 0) {
                ctx.fillStyle = '#6c757d';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', width / 2, height / 2);
                return;
            }

            const maxValue = Math.max(...data.map(d => d.value), 1);
            const barWidth = chartWidth / data.length;

            // Draw bars
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = padding.left + index * barWidth;
                const y = padding.top + chartHeight - barHeight;

                // Bar
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);

                // Value on top
                if (item.value > 0) {
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.value, x + barWidth / 2, y - 5);
                }

                // Label
                ctx.fillStyle = '#6c757d';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.save();
                ctx.translate(x + barWidth / 2, padding.top + chartHeight + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(item.label, 0, 0);
                ctx.restore();
            });

            // Y-axis
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + chartHeight);
            ctx.stroke();

            // X-axis
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
            ctx.stroke();
        }

        // Update statistics overview tab
        function updateOverviewTab() {
            const dailyAvg = Math.round(LogManager.getAverageDailyPushups());
            const streak = LogManager.getCurrentStreak();
            const dailyTotals = LogManager.getDailyTotals();
            const totalDays = Object.keys(dailyTotals).length;
            const total = LogManager.getTotalCompleted();

            document.getElementById('overviewDailyAvg').textContent = dailyAvg;
            document.getElementById('overviewStreak').textContent = streak;
            document.getElementById('overviewTotalDays').textContent = totalDays;
            document.getElementById('overviewTotal').textContent = total.toLocaleString();

            // Draw 30-day chart
            const stats = LogManager.getLastNDaysStats(30);
            const chartData = stats.map(stat => ({
                label: new Date(stat.date).getDate().toString(),
                value: stat.total
            }));

            const canvas = document.getElementById('overviewChart');
            drawBarChart(canvas, chartData);
        }

        // Update trends tab
        let currentTrendPeriod = 7;

        function updateTrendsTab() {
            const avg7 = Math.round(LogManager.getRollingAverage(7));
            const avg14 = Math.round(LogManager.getRollingAverage(14));
            const avg30 = Math.round(LogManager.getRollingAverage(30));

            document.getElementById('trends7Day').textContent = avg7;
            document.getElementById('trends14Day').textContent = avg14;
            document.getElementById('trends30Day').textContent = avg30;

            updateTrendsChart(currentTrendPeriod);
        }

        function updateTrendsChart(days) {
            currentTrendPeriod = days;

            const stats = LogManager.getLastNDaysStats(days);
            const chartData = stats.map(stat => {
                const date = new Date(stat.date);
                return {
                    label: `${date.getMonth() + 1}/${date.getDate()}`,
                    value: stat.total
                };
            });

            document.getElementById('trendsChartTitle').textContent = `Daily Push-ups (Last ${days} Days)`;
            const canvas = document.getElementById('trendsChart');
            drawBarChart(canvas, chartData);
        }

        // Update periods tab
        function updatePeriodsTab() {
            const weeklyTotals = LogManager.getWeeklyTotals();
            const monthlyTotals = LogManager.getMonthlyTotals();

            // Weekly list
            const weeklyList = document.getElementById('weeklyList');
            const sortedWeeks = Object.entries(weeklyTotals).sort((a, b) => b[0].localeCompare(a[0]));

            if (sortedWeeks.length === 0) {
                weeklyList.innerHTML = '<div class="empty-stats"><div class="empty-stats-icon">ðŸ“Š</div>No weekly data yet</div>';
            } else {
                weeklyList.innerHTML = sortedWeeks.map(([weekStart, total]) => {
                    const date = new Date(weekStart);
                    const endDate = new Date(date);
                    endDate.setDate(date.getDate() + 6);

                    return `
                        <div class="period-item">
                            <div class="period-item-label">
                                ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} -
                                ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                            <div class="period-item-value">${total.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }

            // Monthly list
            const monthlyList = document.getElementById('monthlyList');
            const sortedMonths = Object.entries(monthlyTotals).sort((a, b) => b[0].localeCompare(a[0]));

            if (sortedMonths.length === 0) {
                monthlyList.innerHTML = '<div class="empty-stats"><div class="empty-stats-icon">ðŸ“Š</div>No monthly data yet</div>';
            } else {
                monthlyList.innerHTML = sortedMonths.map(([monthKey, total]) => {
                    const [year, month] = monthKey.split('-');
                    const date = new Date(year, parseInt(month) - 1, 1);

                    return `
                        <div class="period-item">
                            <div class="period-item-label">
                                ${date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                            </div>
                            <div class="period-item-value">${total.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update performance tab
        function updatePerformanceTab() {
            const bestDays = LogManager.getBestDays(5);
            const worstDays = LogManager.getWorstDays(5);

            // Best days
            const bestDaysList = document.getElementById('bestDaysList');
            if (bestDays.length === 0) {
                bestDaysList.innerHTML = '<div class="empty-stats"><div class="empty-stats-icon">ðŸ†</div>Start logging to see your best days</div>';
            } else {
                bestDaysList.innerHTML = bestDays.map(day => {
                    const date = new Date(day.date);
                    return `
                        <div class="day-item best">
                            <div class="day-item-date">${formatDate(date.toISOString())}</div>
                            <div class="day-item-total">${day.total}</div>
                        </div>
                    `;
                }).join('');
            }

            // Worst days
            const worstDaysList = document.getElementById('worstDaysList');
            if (worstDays.length === 0) {
                worstDaysList.innerHTML = '<div class="empty-stats"><div class="empty-stats-icon">ðŸ“‰</div>Start logging to see areas for improvement</div>';
            } else {
                worstDaysList.innerHTML = worstDays.map(day => {
                    const date = new Date(day.date);
                    return `
                        <div class="day-item worst">
                            <div class="day-item-date">${formatDate(date.toISOString())}</div>
                            <div class="day-item-total">${day.total}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update all statistics
        function updateStatistics() {
            updateOverviewTab();
            updateTrendsTab();
            updatePeriodsTab();
            updatePerformanceTab();
        }

        // Update gamification elements
        function updateGamification() {
            const totalCompleted = LogManager.getTotalCompleted();
            const currentStreak = LogManager.getCurrentStreak();
            const longestStreak = LogManager.getLongestStreak();

            // Update streak values
            document.getElementById('currentStreakValue').textContent = currentStreak;
            document.getElementById('longestStreakValue').textContent = longestStreak;

            // Render badges
            renderBadges(totalCompleted, longestStreak);

            // Update status indicator
            updateStatusIndicator();
        }

        // Render badge grid
        function renderBadges(totalCompleted, longestStreak) {
            const container = document.getElementById('badgesContainer');

            container.innerHTML = BADGES.map(badge => {
                const isEarned = badge.type === 'streak'
                    ? longestStreak >= badge.threshold
                    : totalCompleted >= badge.threshold;

                return `
                    <div class="badge-item ${isEarned ? 'earned' : ''}">
                        ${!isEarned ? '<span class="badge-locked">ðŸ”’</span>' : ''}
                        <span class="badge-icon">${badge.icon}</span>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-description">${badge.description}</div>
                    </div>
                `;
            }).join('');
        }

        // Update status indicator (ahead/on track/behind)
        function updateStatusIndicator() {
            const settings = Settings.load();
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            if (!settings || !settings.endDate) {
                statusIndicator.className = 'status-indicator no-deadline';
                statusIndicator.innerHTML = `
                    <span class="status-icon">â„¹ï¸</span>
                    <span id="statusText">Set an end date to track your progress status</span>
                `;
                return;
            }

            const totalCompleted = LogManager.getTotalCompleted();
            const target = settings.target;
            const endDate = new Date(settings.endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const totalDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) + 1;
            const daysRemaining = Math.max(0, totalDays);

            if (daysRemaining === 0) {
                // Deadline reached
                if (totalCompleted >= target) {
                    statusIndicator.className = 'status-indicator ahead';
                    statusIndicator.innerHTML = `
                        <span class="status-icon">ðŸŽ‰</span>
                        <span id="statusText">Goal Achieved! You completed ${totalCompleted.toLocaleString()} push-ups!</span>
                    `;
                } else {
                    statusIndicator.className = 'status-indicator behind';
                    statusIndicator.innerHTML = `
                        <span class="status-icon">â°</span>
                        <span id="statusText">Deadline reached. Keep going to reach your goal!</span>
                    `;
                }
                return;
            }

            // Calculate where we should be based on time elapsed
            const startDate = new Date(settings.lastUpdated || today);
            startDate.setHours(0, 0, 0, 0);
            const totalDuration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const daysElapsed = totalDuration - daysRemaining;
            const expectedProgress = daysElapsed > 0 ? (target / totalDuration) * daysElapsed : 0;

            // Determine status with 5% tolerance
            const tolerance = target * 0.05;

            if (totalCompleted >= target) {
                statusIndicator.className = 'status-indicator ahead';
                statusIndicator.innerHTML = `
                    <span class="status-icon">ðŸŽ‰</span>
                    <span id="statusText">Goal Achieved! You're done early!</span>
                `;
            } else if (totalCompleted >= expectedProgress + tolerance) {
                statusIndicator.className = 'status-indicator ahead';
                const ahead = Math.round(totalCompleted - expectedProgress);
                statusIndicator.innerHTML = `
                    <span class="status-icon">ðŸš€</span>
                    <span id="statusText">Ahead of Schedule! (+${ahead} push-ups)</span>
                `;
            } else if (totalCompleted >= expectedProgress - tolerance) {
                statusIndicator.className = 'status-indicator on-track';
                statusIndicator.innerHTML = `
                    <span class="status-icon">âœ“</span>
                    <span id="statusText">On Track - Keep up the great work!</span>
                `;
            } else {
                statusIndicator.className = 'status-indicator behind';
                const behind = Math.round(expectedProgress - totalCompleted);
                const neededPace = Math.ceil((target - totalCompleted) / daysRemaining);
                statusIndicator.innerHTML = `
                    <span class="status-icon">âš ï¸</span>
                    <span id="statusText">Behind Schedule (-${behind} push-ups) - Need ${neededPace}/day to catch up</span>
                `;
            }
        }

        // Initialize app
        // Main app initialization (called after auth lock screen or directly if auth already resolved)
        async function continueToApp() {
            console.log('[continueToApp] Starting app initialization...');
            // Initialize Google Sheets Sync (only if authenticated)
            const authState = localStorage.getItem('pushupTrackerAuthState');
            console.log('[continueToApp] Auth state from localStorage:', authState);
            if (authState) {
                const state = JSON.parse(authState);
                console.log('[continueToApp] Parsed auth state:', state.authState);
                if (state.authState === 'AUTHENTICATED') {
                    console.log('[continueToApp] User is authenticated - initializing Google Sheets sync');
                    await GoogleSheetsSync.init();
                } else {
                    // Local-only mode - don't initialize Google Sheets
                    console.log('[continueToApp] Running in local-only mode - skipping Google Sheets init');
                }
            } else {
                console.log('[continueToApp] No auth state found - skipping Google Sheets init');
            }

            const settings = Settings.load();
            const settingsEditCard = document.getElementById('settingsEditCard');

            if (settings) {
                // AC-AUTH-2.6: Show user account container
                document.getElementById('userAccountContainer')?.classList.remove('hidden');
                // Sync on app open (only if authenticated)
                if (GoogleSheetsSync.isSignedIn) {
                    await GoogleSheetsSync.performFullSync();
                }
                // Show dashboard, hide settings form
                showDashboard(settings);
                // Show gamification card (kept for backwards compatibility but hidden)
                gamificationCard.classList.remove('hidden');
                // Show progress card (kept for backwards compatibility but hidden)
                progressCard.classList.remove('hidden');
                // Show statistics card
                statisticsCard.classList.remove('hidden');
                // Show log card
                logCard.classList.remove('hidden');
                // Show history card
                historyCard.classList.remove('hidden');
                // Show settings edit card at bottom
                if (settingsEditCard) {
                    settingsEditCard.classList.remove('hidden');
                }
                // Update today's total
                updateTodayTotal();
                // Update progress tracking
                updateProgressTracking();
                // Update gamification
                updateGamification();
                // Update statistics
                updateStatistics();
                // Display log history
                displayLogHistory();
            } else {
                // Show settings form
                settingsCard.classList.remove('hidden');
                dashboardCard.classList.add('hidden');
                gamificationCard.classList.add('hidden');
                progressCard.classList.add('hidden');
                statisticsCard.classList.add('hidden');
                logCard.classList.add('hidden');
                historyCard.classList.add('hidden');
                if (settingsEditCard) {
                    settingsEditCard.classList.add('hidden');
                }
            }

            // Set min date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            endDateInput.min = tomorrow.toISOString().split('T')[0];
        }

        // Global reference for AuthLockScreen to call
        window.continueToApp = continueToApp;

        async function init() {
            // AC-LOGIN-1.20: Check auth lock screen state BEFORE initializing anything
            const lockScreenActive = AuthLockScreen.init();

            if (lockScreenActive) {
                // Lock screen is showing - wait for user decision
                // continueToApp() will be called when user taps Continue
                console.log('Auth lock screen active - waiting for user decision');
                return;
            }

            // Auth decision already made - proceed to app
            await continueToApp();
        }

        // Validation
        function validateTarget(value) {
            const num = parseInt(value);
            return !isNaN(num) && num > 0 && num === parseFloat(value);
        }

        function validateEndDate(value) {
            if (!value) return true; // Optional field
            const selectedDate = new Date(value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return selectedDate > today;
        }

        // Calculate days remaining
        function calculateDaysRemaining(endDate) {
            if (!endDate) return null;
            const end = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = end - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        // Calculate daily pace
        function calculateDailyPace(target, endDate) {
            const daysRemaining = calculateDaysRemaining(endDate);
            if (!daysRemaining || daysRemaining === 0) return null;
            return Math.ceil(target / daysRemaining);
        }

        // Show dashboard with settings
        function showDashboard(settings) {
            settingsCard.classList.add('hidden');
            dashboardCard.classList.remove('hidden');

            // Update display
            targetDisplay.textContent = settings.target.toLocaleString();

            if (settings.endDate) {
                const endDate = new Date(settings.endDate);
                endDateDisplay.textContent = endDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const daysRemaining = calculateDaysRemaining(settings.endDate);
                const dailyPace = calculateDailyPace(settings.target, settings.endDate);

                daysRemainingRow.style.display = 'flex';
                dailyPaceRow.style.display = 'flex';
                daysRemainingDisplay.textContent = daysRemaining;
                dailyPaceDisplay.textContent = `${dailyPace}/day`;
            } else {
                endDateDisplay.textContent = 'Not set';
                daysRemainingRow.style.display = 'none';
                dailyPaceRow.style.display = 'none';
            }
        }

        // Show settings form
        function showSettings(settings = null) {
            settingsCard.classList.remove('hidden');
            dashboardCard.classList.add('hidden');

            if (settings) {
                targetInput.value = settings.target;
                endDateInput.value = settings.endDate || '';
            }
        }

        // Show success message
        function showSuccessMessage(message = 'âœ… Settings saved successfully!') {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }

        // Update today's total
        function updateTodayTotal() {
            const total = LogManager.getTodayTotal();
            todayTotal.textContent = total.toLocaleString();
        }

        // Update progress tracking
        function updateProgressTracking() {
            const settings = Settings.load();
            if (!settings) return;

            const target = settings.target;
            const completed = LogManager.getTotalCompleted();
            const remaining = Math.max(0, target - completed);
            const percentage = Math.min(100, Math.round((completed / target) * 100));

            // Update progress bar
            progressBarFill.style.width = `${percentage}%`;
            progressBarText.textContent = `${percentage}%`;

            // Update stats
            totalCompleted.textContent = completed.toLocaleString();
            totalRemaining.textContent = remaining.toLocaleString();

            // Update hero progress bar
            updateHeroProgress();

            // Calculate projected completion date
            const avgDaily = LogManager.getAverageDailyPushups();

            if (avgDaily > 0 && remaining > 0) {
                const daysNeeded = Math.ceil(remaining / avgDaily);
                const projectedDate = new Date();
                projectedDate.setDate(projectedDate.getDate() + daysNeeded);

                projectionDate.textContent = projectedDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Add note about pace
                projectionNote.textContent = `Based on your current pace of ${Math.round(avgDaily)} push-ups/day`;

                // Check if we're on track with end date
                if (settings.endDate) {
                    const endDate = new Date(settings.endDate);
                    if (projectedDate > endDate) {
                        projectionNote.textContent = `âš ï¸ Behind schedule - increase daily pace to meet deadline`;
                    } else {
                        projectionNote.textContent = `âœ“ On track to meet deadline`;
                    }
                }
            } else if (remaining === 0) {
                projectionDate.textContent = 'ðŸŽ‰ Goal Achieved!';
                projectionNote.textContent = 'Congratulations on reaching your target!';
            } else {
                projectionDate.textContent = 'Start logging to see projection';
                projectionNote.textContent = '';
            }
        }

        // Format date for display
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            today.setHours(0, 0, 0, 0);
            yesterday.setHours(0, 0, 0, 0);
            const logDate = new Date(date);
            logDate.setHours(0, 0, 0, 0);

            if (logDate.getTime() === today.getTime()) {
                return 'Today';
            } else if (logDate.getTime() === yesterday.getTime()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
        }

        // Format time for display
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Display log history
        function displayLogHistory() {
            const logs = LogManager.getAllLogs();

            if (logs.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <div class="empty-state-text">No push-ups logged yet. Start tracking your progress!</div>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = logs.map(log => `
                <div class="history-item" data-id="${log.id}">
                    <div class="history-item-info">
                        <div class="history-item-amount" data-amount="${log.amount}">
                            ${log.amount} push-ups${log.edited ? ' <span style="font-size: 0.6em; color: #6c757d;">(edited)</span>' : ''}
                        </div>
                        <div class="history-item-date">${formatDate(log.timestamp)}</div>
                        <div class="history-item-time">${formatTime(log.timestamp)}</div>
                    </div>
                    <div class="history-item-actions">
                        <button class="btn-icon btn-edit" onclick="editLogEntry(${log.id})">Edit</button>
                        <button class="btn-icon btn-delete" onclick="deleteLogEntry(${log.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Validate log amount
        function validateLogAmount(value) {
            const num = parseInt(value);
            return !isNaN(num) && num > 0 && num === parseFloat(value);
        }

        // Log push-ups
        function logPushups(amount) {
            if (!validateLogAmount(amount)) {
                logError.classList.add('show');
                return;
            }

            logError.classList.remove('show');
            LogManager.addLog(amount);
            updateTodayTotal();
            updateProgressTracking();
            updateGamification();
            updateStatistics();
            displayLogHistory();
            showSuccessMessage(`âœ… Logged ${amount} push-ups!`);

            // Clear custom input if it was used
            customAmountInput.value = '';
        }

        // Edit log entry
        function editLogEntry(id) {
            const historyItem = document.querySelector(`[data-id="${id}"]`);
            const log = LogManager.getAllLogs().find(l => l.id === id);

            if (!log) return;

            // Get current values
            const currentAmount = log.amount;
            const currentDate = new Date(log.timestamp);
            const dateString = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeString = currentDate.toTimeString().slice(0, 5); // HH:MM

            // Replace entire history item with edit form
            historyItem.innerHTML = `
                <div class="history-item-edit-form">
                    <div class="edit-form-group">
                        <label for="editAmount${id}">Push-ups:</label>
                        <input type="number" class="edit-input" value="${currentAmount}" min="1" step="1" id="editAmount${id}">
                    </div>
                    <div class="edit-form-group">
                        <label for="editDate${id}">Date:</label>
                        <input type="date" class="edit-input" value="${dateString}" id="editDate${id}">
                    </div>
                    <div class="edit-form-group">
                        <label for="editTime${id}">Time:</label>
                        <input type="time" class="edit-input" value="${timeString}" id="editTime${id}">
                    </div>
                    <div class="history-item-actions">
                        <button class="btn-icon btn-save" onclick="saveLogEntry(${id})">Save</button>
                        <button class="btn-icon btn-cancel" onclick="cancelEditLogEntry(${id})">Cancel</button>
                    </div>
                </div>
            `;

            // Focus the amount input
            document.getElementById(`editAmount${id}`).focus();
            document.getElementById(`editAmount${id}`).select();
        }

        // Save edited log entry
        function saveLogEntry(id) {
            const amountInput = document.getElementById(`editAmount${id}`);
            const dateInput = document.getElementById(`editDate${id}`);
            const timeInput = document.getElementById(`editTime${id}`);

            const newAmount = amountInput.value;
            const newDate = dateInput.value;
            const newTime = timeInput.value;

            // Validate amount
            if (!validateLogAmount(newAmount)) {
                amountInput.style.borderColor = '#f5576c';
                return;
            }

            // Validate date
            if (!newDate) {
                dateInput.style.borderColor = '#f5576c';
                return;
            }

            // Validate time
            if (!newTime) {
                timeInput.style.borderColor = '#f5576c';
                return;
            }

            // Construct new timestamp
            const newTimestamp = new Date(`${newDate}T${newTime}`);

            // Validate that the date is valid
            if (isNaN(newTimestamp.getTime())) {
                dateInput.style.borderColor = '#f5576c';
                timeInput.style.borderColor = '#f5576c';
                return;
            }

            // Validate that the date is not in the future
            if (newTimestamp > new Date()) {
                dateInput.style.borderColor = '#f5576c';
                timeInput.style.borderColor = '#f5576c';
                showSuccessMessage('âŒ Cannot set a date/time in the future!');
                return;
            }

            // Update the log entry
            if (LogManager.editLog(id, parseInt(newAmount), newTimestamp.toISOString())) {
                updateTodayTotal();
                updateProgressTracking();
                updateGamification();
                updateStatistics();
                displayLogHistory();
                showSuccessMessage('âœ… Entry updated successfully!');
            }
        }

        // Cancel edit log entry
        function cancelEditLogEntry(id) {
            displayLogHistory();
        }

        // Delete log entry
        function deleteLogEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                if (LogManager.deleteLog(id)) {
                    updateTodayTotal();
                    updateProgressTracking();
                    updateGamification();
                    updateStatistics();
                    displayLogHistory();
                    showSuccessMessage('âœ… Entry deleted successfully!');
                }
            }
        }

        // Form submission
        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const target = targetInput.value;
            const endDate = endDateInput.value;

            // Validate
            let isValid = true;

            if (!validateTarget(target)) {
                targetError.classList.add('show');
                isValid = false;
            } else {
                targetError.classList.remove('show');
            }

            if (!validateEndDate(endDate)) {
                dateError.classList.add('show');
                isValid = false;
            } else {
                dateError.classList.remove('show');
            }

            if (!isValid) return;

            // Save settings
            const settings = Settings.save(target, endDate);

            // Show success message and dashboard
            showSuccessMessage();
            showDashboard(settings);

            // Show gamification card, progress card, statistics card, log card and history card
            gamificationCard.classList.remove('hidden');
            progressCard.classList.remove('hidden');
            statisticsCard.classList.remove('hidden');
            logCard.classList.remove('hidden');
            historyCard.classList.remove('hidden');
            const settingsEditCard = document.getElementById('settingsEditCard');
            if (settingsEditCard) {
                settingsEditCard.classList.remove('hidden');
            }
            updateTodayTotal();
            updateProgressTracking();
            updateGamification();
            updateStatistics();
            displayLogHistory();
        });

        // Edit settings button
        editSettingsBtn.addEventListener('click', () => {
            const settings = Settings.load();
            showSettings(settings);
        });

        // Quick-add buttons
        quickAddButtons.forEach(button => {
            button.addEventListener('click', () => {
                const amount = button.dataset.value;
                logPushups(amount);
            });
        });

        // Custom log button
        logCustomBtn.addEventListener('click', () => {
            const amount = customAmountInput.value;
            logPushups(amount);
        });

        // Allow Enter key to log custom amount
        customAmountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const amount = customAmountInput.value;
                logPushups(amount);
            }
        });

        // Real-time validation for custom input
        customAmountInput.addEventListener('input', () => {
            if (customAmountInput.value && !validateLogAmount(customAmountInput.value)) {
                logError.classList.add('show');
            } else {
                logError.classList.remove('show');
            }
        });

        // Real-time validation
        targetInput.addEventListener('input', () => {
            if (targetInput.value && !validateTarget(targetInput.value)) {
                targetError.classList.add('show');
            } else {
                targetError.classList.remove('show');
            }
        });

        endDateInput.addEventListener('change', () => {
            if (endDateInput.value && !validateEndDate(endDateInput.value)) {
                dateError.classList.add('show');
            } else {
                dateError.classList.remove('show');
            }
        });

        // Statistics tab switching
        statsTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // Update active tab
                statsTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                statsTabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}Tab`).classList.add('active');
            });
        });

        // Period selector for trends chart
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const period = parseInt(btn.dataset.period);

                // Update active button
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update chart
                updateTrendsChart(period);
            });
        });

        // Google Sheets event handlers
        document.getElementById('googleSignInBtn')?.addEventListener('click', () => {
            GoogleSheetsSync.signIn();
        });

        document.getElementById('manualSyncBtn')?.addEventListener('click', async () => {
            if (!GoogleSheetsSync.isSyncing) {
                await GoogleSheetsSync.performFullSync();
            }
        });

        document.getElementById('disconnectBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to disconnect from Google Sheets? Your local data will remain safe.')) {
                GoogleSheetsSync.signOut();
            }
        });

        // User Account View event handlers (AC-AUTH-2.3: Account-related actions)
        document.getElementById('googleSignInBtnNew')?.addEventListener('click', () => {
            GoogleSheetsSync.signIn();
        });

        document.getElementById('signOutBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to sign out? Your local data will remain safe, but you won\'t sync to Google Sheets until you sign in again.')) {
                GoogleSheetsSync.signOut();
            }
        });

        document.getElementById('manualSyncBtnNew')?.addEventListener('click', async () => {
            if (!GoogleSheetsSync.isSyncing) {
                await GoogleSheetsSync.performFullSync();
            }
        });

        // Sync on page unload (when closing tab/browser)
        window.addEventListener('beforeunload', async (e) => {
            if (GoogleSheetsSync.isSignedIn && GoogleSheetsSync.getQueue().length > 0) {
                // If there are pending changes, sync them
                try {
                    await GoogleSheetsSync.performFullSync();
                } catch (error) {
                    console.error('Failed to sync on unload:', error);
                }
            }
        });

        // Initialize on load
        OfflineManager.init();
        init();
    </script>
</body>
</html>
